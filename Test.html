<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qatar North Traffic Junctions Survey Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --aktor-blue: #111827;
      --aktor-red: #e0283b;
      --algo-blue: #0070c9;
      --card-bg: #ffffff;
      --bg-surface: rgba(15, 23, 42, 0.85);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color: #111827;
      background-image: url('bg-image.png');
      background-color: #020617;
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
      background-size: cover;
    }

    .page {
      width: 100%;
      min-height: 100vh;
      background: linear-gradient(
        180deg,
        rgba(15, 23, 42, 0.88) 0%,
        rgba(15, 23, 42, 0.96) 40%,
        #020617 100%
      );
    }

    .shell {
      max-width: 1440px;
      margin: 0 auto;
      padding: 16px;
    }

    .glass-card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 16px;
      box-shadow:
        0 20px 45px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(148, 163, 184, 0.3);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 12px 16px;
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }

    .glass-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.16), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.16), transparent 50%);
      opacity: 0.9;
      pointer-events: none;
    }

    .glass-card > * {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 10px;
      padding: 12px 16px;
      border-radius: 18px;
      background:
        linear-gradient(
          135deg,
          rgba(15, 23, 42, 0.98),
          rgba(15, 23, 42, 0.96)
        );
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .header-left,
    .header-right {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
    }

    .header-center {
      flex: 1 1 auto;
      text-align: center;
    }

    .logo-img {
      max-height: 56px;
      height: auto;
      filter: drop-shadow(0 10px 24px rgba(0, 0, 0, 0.9));
    }

    .logo-img-small {
      max-height: 44px;
    }

    .main-title {
      font-size: clamp(18px, 2vw, 22px);
      font-weight: 700;
      color: #f9fafb;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .subtitle {
      font-size: 12px;
      color: #e5e7eb;
      margin-top: 2px;
    }

    .subtitle span {
      color: #93c5fd;
    }

    .meta-text {
      margin-top: 4px;
      font-size: 11px;
      color: #d1d5db;
    }

    .meta-text span {
      color: #a5b4fc;
      font-weight: 500;
    }

    .content-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.3fr);
      gap: 12px;
    }

    .left-column,
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .section-title-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .section-title {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .section-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .section-title-row small {
      font-size: 11px;
      color: #9ca3af;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 10px;
    }

    .kpi-card {
      border-radius: 14px;
      background: radial-gradient(circle at 0 0, #f9fafb, #e5e7eb);
      padding: 10px 12px;
      box-shadow:
        0 16px 32px rgba(15, 23, 42, 0.65),
        0 0 0 1px rgba(148, 163, 184, 0.4);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::before {
      content: "";
      position: absolute;
      inset: -50%;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.25), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.18), transparent 55%);
      opacity: 0.4;
      pointer-events: none;
    }

    .kpi-card-content {
      position: relative;
      z-index: 1;
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      color: #4b5563;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .kpi-label span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      box-shadow: 0 0 8px rgba(56, 189, 248, 0.8);
    }

    .kpi-main-row {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 6px;
    }

    .kpi-value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    .kpi-unit {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #6b7280;
    }

    .kpi-subtext {
      font-size: 11px;
      color: #6b7280;
    }

    .kpi-secondary {
      font-size: 11px;
      color: #4b5563;
      margin-top: 2px;
    }

    .kpi-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.08);
      color: #065f46;
      font-size: 10px;
      margin-top: 4px;
    }

    .kpi-tag span.dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(16, 185, 129, 0.85);
    }

    .kpi-alert {
      background: rgba(220, 38, 38, 0.06);
      color: #b91c1c;
    }

    .kpi-alert span.dot {
      background: #ef4444;
      box-shadow: 0 0 6px rgba(239, 68, 68, 0.9);
    }

    .filters-card {
      margin-top: 4px;
    }

    .filters-row-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-start;
      margin-top: 4px;
    }

    .filters label {
      font-size: 11px;
      color: #374151;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .filters select {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      font-size: 11px;
      min-width: 130px;
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.06), transparent 60%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.96));
      color: #e5e7eb;
      outline: none;
      transition:
        border-color 200ms cubic-bezier(0.22, 0.61, 0.36, 1),
        box-shadow 200ms cubic-bezier(0.22, 0.61, 0.36, 1),
        background 200ms cubic-bezier(0.22, 0.61, 0.36, 1),
        transform 200ms cubic-bezier(0.22, 0.61, 0.36, 1);
      appearance: none;
      -webkit-appearance: none;
    }

    .filters select:hover {
      border-color: rgba(248, 250, 252, 0.35);
    }

    .filters select:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8);
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.25), transparent 60%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
      transform: translateY(-1px);
    }

    .active-filters {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }

    .active-filters span {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
    }

    .map-card {
      padding: 12px 12px 10px;
    }

    .map-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .map-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .map-title span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.8);
    }

    .map-mode-toggle {
      padding: 6px 12px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background 150ms ease-out,
        border-color 150ms ease-out,
        transform 150ms ease-out,
        box-shadow 150ms ease-out;
    }

    .map-mode-toggle span {
      font-size: 13px;
    }

    .map-mode-toggle.active {
      background: linear-gradient(135deg, #0f766e, #22c55e);
      border-color: rgba(16, 185, 129, 0.9);
      box-shadow: 0 12px 28px rgba(4, 120, 87, 0.6);
      color: #ecfeff;
      transform: translateY(-1px);
    }

    #map {
      width: 100%;
      height: 360px;
      border-radius: 14px;
      border: 1px solid rgba(30, 64, 175, 0.6);
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.95);
      overflow: hidden;
    }

    .map-footer {
      margin-top: 4px;
      font-size: 11px;
      color: #e5e7eb;
    }

    .map-footer span {
      color: #a5b4fc;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap: 8px;
    }

    .chart-card {
      border-radius: 16px;
      background: radial-gradient(circle at 0 0, #f9fafb, #e5e7eb);
      padding: 10px;
      box-shadow:
        0 16px 32px rgba(15, 23, 42, 0.65),
        0 0 0 1px rgba(148, 163, 184, 0.4);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chart-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #4b5563;
    }

    .chart-subtitle {
      font-size: 11px;
      color: #6b7280;
    }

    .chart-wrapper {
      height: 210px;
      margin-top: 4px;
    }

    .chart-footer {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .table-card {
      margin-top: 10px;
    }

    .table-header-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .table-title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .table-title {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .table-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .table-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .search-box input {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      min-width: 160px;
      background: #020617;
      color: #e5e7eb;
    }

    .search-box input::placeholder {
      color: #6b7280;
    }

    .search-box input:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.7);
      background: #020617;
    }

    .btn-export {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.85);
      background: linear-gradient(135deg, #1d4ed8, #0ea5e9);
      color: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 28px rgba(30, 64, 175, 0.7);
    }

    .btn-export span {
      font-size: 13px;
    }

    .btn-export:hover {
      filter: brightness(1.05);
    }

    .btn-export:active {
      transform: translateY(1px);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.8);
    }

    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(30, 64, 175, 0.8);
      background: #020617;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.95);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      color: #e5e7eb;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      white-space: nowrap;
      text-align: left;
    }

    th {
      background: #020617;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 10px;
      color: #9ca3af;
    }

    tbody tr:nth-child(odd) {
      background: #020617;
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    tbody tr:hover {
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), rgba(3, 7, 18, 0.98));
      cursor: pointer;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      color: white;
    }

    .badge-completed {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.85);
    }

    .badge-pending {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.85);
    }

    .badge-clarification {
      background: linear-gradient(135deg, #f97316, #ea580c);
      box-shadow: 0 0 12px rgba(249, 115, 22, 0.8);
    }

    .badge-neutral {
      background: linear-gradient(135deg, #6b7280, #4b5563);
    }

    .zone-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
    }

    .zone-pill span.dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #0ea5e9;
      box-shadow: 0 0 8px rgba(14, 165, 233, 0.9);
    }

    .legend-text {
      font-size: 11px;
      color: #e5e7eb;
      margin-top: 4px;
    }

    .legend-text span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 8px;
    }

    .legend-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      display: inline-block;
    }

    .legend-dot.completed {
      background: #16a34a;
      box-shadow: 0 0 6px rgba(22, 163, 74, 0.9);
    }

    .legend-dot.pending {
      background: #dc2626;
      box-shadow: 0 0 6px rgba(220, 38, 38, 0.9);
    }

    .legend-dot.selected {
      background: #0ea5e9;
      box-shadow: 0 0 6px rgba(14, 165, 233, 0.9);
    }

    @media (max-width: 1100px) {
      .content-layout {
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 960px) {
      .content-layout {
        grid-template-columns: 1fr;
      }

      #map {
        height: 320px;
      }

      .charts-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .shell {
        padding: 10px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-center {
        text-align: left;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .table-tools {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box input {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .main-title {
        font-size: 16px;
        letter-spacing: 0.08em;
      }

      .logo-img {
        max-height: 46px;
      }

      .logo-img-small {
        max-height: 36px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="shell">
      <header>
        <div class="header-left">
          <img src="aktor-logo.png" alt="Aktor Logo" class="logo-img" />
        </div>
        <div class="header-center">
          <div class="main-title">Qatar North Traffic Junctions Survey Dashboard</div>
          <div class="subtitle">
            Real-time view of <span>Traffic Junctions</span> &amp; Survey Progress
          </div>
          <div class="meta-text">
            Live from Google Sheet &mdash; Last Refreshed: <span id="lastUpdatedText">Loading...</span>
          </div>
        </div>
        <div class="header-right">
          <img src="algosystems-logo.png" alt="Algosystems" class="logo-img logo-img-small" />
        </div>
      </header>

      <div class="content-layout">
        <div class="left-column">
          <div class="glass-card">
            <div class="section-title-row">
              <div>
                <div class="section-title">Survey Overview</div>
                <div class="section-subtitle">Key metrics for all traffic junctions in scope</div>
              </div>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-card-content">
                  <div class="kpi-label">
                    <span class="dot"></span>
                    Total Junctions
                  </div>
                  <div class="kpi-main-row">
                    <div class="kpi-value" id="totalJunctions">0</div>
                    <div class="kpi-unit">Sites</div>
                  </div>
                  <div class="kpi-subtext">
                    Total traffic junctions considered in this dashboard.
                  </div>
                </div>
              </div>

              <div class="kpi-card">
                <div class="kpi-card-content">
                  <div class="kpi-label">
                    <span class="dot"></span>
                    Junctions Surveyed
                  </div>
                  <div class="kpi-main-row">
                    <div class="kpi-value" id="surveyedJunctions">0</div>
                    <div class="kpi-unit">Sites</div>
                  </div>
                  <div class="kpi-subtext">
                    Junctions with at least one survey entry completed.
                  </div>
                  <div class="kpi-secondary">
                    <span id="surveyedPercentage">0%</span> of total junctions covered.
                  </div>
                </div>
              </div>

              <div class="kpi-card">
                <div class="kpi-card-content">
                  <div class="kpi-label">
                    <span class="dot"></span>
                    Junctions Pending
                  </div>
                  <div class="kpi-main-row">
                    <div class="kpi-value" id="pendingJunctions">0</div>
                    <div class="kpi-unit">Sites</div>
                  </div>
                  <div class="kpi-subtext">
                    Junctions not yet surveyed (no completed survey entry).
                  </div>
                  <div class="kpi-tag kpi-alert">
                    <span class="dot"></span>
                    <span id="pendingPercentage">0%</span> pending coverage
                  </div>
                </div>
              </div>

              <div class="kpi-card">
                <div class="kpi-card-content">
                  <div class="kpi-label">
                    <span class="dot"></span>
                    Sites Visited
                  </div>
                  <div class="kpi-main-row">
                    <div class="kpi-value" id="sitesVisited">0</div>
                    <div class="kpi-unit">Visits</div>
                  </div>
                  <div class="kpi-subtext">
                    Count of unique junctions where either the Controller or Poles survey is marked visited.
                  </div>
                  <div class="kpi-secondary">
                    Calculated from <strong>Poles Survey</strong> and <strong>Controller Survey</strong> flags.
                  </div>
                </div>
              </div>

              <div class="kpi-card">
                <div class="kpi-card-content">
                  <div class="kpi-label">
                    <span class="dot"></span>
                    Doha Region Junctions
                  </div>
                  <div class="kpi-main-row">
                    <div class="kpi-value" id="dohaJunctions">0</div>
                    <div class="kpi-unit">Sites</div>
                  </div>
                  <div class="kpi-subtext" id="dohaSurveyText">
                    Junctions within Doha Region.
                  </div>
                  <div class="kpi-secondary" id="dohaSurveyPercentage">
                    0 / 0 surveyed (0%).
                  </div>
                </div>
              </div>

              <div class="kpi-card">
                <div class="kpi-card-content">
                  <div class="kpi-label">
                    <span class="dot"></span>
                    North Region Junctions
                  </div>
                  <div class="kpi-main-row">
                    <div class="kpi-value" id="northJunctions">0</div>
                    <div class="kpi-unit">Sites</div>
                  </div>
                  <div class="kpi-subtext" id="northSurveyText">
                    Junctions within North Region.
                  </div>
                  <div class="kpi-secondary" id="northSurveyPercentage">
                    0 / 0 surveyed (0%).
                  </div>
                </div>
              </div>
            </div>

            <div class="filters-card">
              <div class="filters-row-title">Filters</div>
              <div class="filters-row">
                <div class="filters">
                  <label>
                    Municipality
                    <select id="municipalityFilter">
                      <option value="All">All</option>
                    </select>
                  </label>

                  <label>
                    Region
                    <select id="regionFilter">
                      <option value="All">All</option>
                      <option value="Doha Region">Doha Region</option>
                      <option value="North Region">North Region</option>
                    </select>
                  </label>

                  <label>
                    Area
                    <select id="areaFilter">
                      <option value="All">All</option>
                    </select>
                  </label>

                  <label>
                    Survey Status
                    <select id="surveyStatusFilter">
                      <option value="All">All</option>
                      <option value="Completed">Completed</option>
                      <option value="Pending">Pending</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="active-filters" id="activeFiltersDisplay">
                No filters applied.
              </div>
            </div>
          </div>

          <div class="glass-card table-card">
            <div class="table-header-row">
              <div class="table-title-group">
                <div class="table-title">Traffic Junctions List</div>
                <div class="table-subtitle">
                  Click a row to hover on the map, filter by region/area/survey status.
                </div>
              </div>
              <div class="table-tools">
                <div class="search-box">
                  <input
                    type="text"
                    id="searchInput"
                    placeholder="Search by Junction No, Name, Municipality, or Remarks..."
                  />
                </div>
                <button id="downloadBtn" class="btn-export">
                  <span>⬇</span>
                  Export Filtered List (CSV)
                </button>
              </div>
            </div>

            <div class="table-wrapper">
              <table id="junctionsTable">
                <thead>
                  <tr>
                    <th style="width: 60px;">Sr. No.</th>
                    <th style="width: 80px;">Junction No.</th>
                    <th>Junction Name</th>
                    <th>Municipality</th>
                    <th>Region</th>
                    <th>Area</th>
                    <th>Survey Status</th>
                    <th>Poles Survey</th>
                    <th>Controller Survey</th>
                    <th>CCTV</th>
                    <th>Remarks</th>
                  </tr>
                </thead>
                <tbody id="junctionsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="right-column">
          <div class="glass-card map-card">
            <div class="map-header-row">
              <div>
                <div class="map-title">
                  <span class="dot"></span>
                  Traffic Junctions Map (ESRI)
                </div>
                <div class="section-subtitle">
                  Satellite view of all junctions with survey status overlay.
                </div>
              </div>
              <button id="mapModeToggle" class="map-mode-toggle active">
                <span>●</span>
                Single Junction Focus
              </button>
            </div>
            <div id="map"></div>
            <div class="map-footer">
              <span>Legend:</span>
              <span class="legend-dot completed"></span> Completed
              <span class="legend-dot pending"></span> Pending
              <span class="legend-dot selected"></span> Selected Row
            </div>
          </div>

          <div class="charts-grid">
            <div class="chart-card">
              <div class="chart-title">Survey Status by Region</div>
              <div class="chart-subtitle">
                Comparison of completed vs pending junctions in Doha vs North Region.
              </div>
              <div class="chart-wrapper">
                <canvas id="regionStatusChart"></canvas>
              </div>
              <div class="chart-footer">
                Helps visualize which region requires more focus to achieve full survey coverage.
              </div>
            </div>

            <div class="chart-card">
              <div class="chart-title">Survey Status by Municipality</div>
              <div class="chart-subtitle">
                Top municipalities by number of completed vs pending junctions.
              </div>
              <div class="chart-wrapper">
                <canvas id="municipalityStatusChart"></canvas>
              </div>
              <div class="chart-footer">
                Use this to plan survey teams and prioritize lower coverage municipalities.
              </div>
            </div>
          </div>

          <div class="glass-card">
            <div class="section-title-row">
              <div>
                <div class="section-title">Insights</div>
                <div class="section-subtitle">
                  Quick highlights based on current filters.
                </div>
              </div>
            </div>
            <div class="legend-text" id="insightsText">
              Insights will appear here after data is loaded.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAtt1gpGtyrb-_w9rkqmdBMyrrrPWmPbEmprtJ-A-E1INhMCW1WLYXST2agnYFBS4wpUXsYY5cT90X/pub?gid=0&single=true&output=csv";

    let allRows = [];
    let filteredRows = [];
    let map;
    let markersLayer;
    let regionStatusChart;
    let municipalityStatusChart;
    let singleSelectionMode = true;

    const municipalityFilterEl = document.getElementById("municipalityFilter");
    const regionFilterEl = document.getElementById("regionFilter");
    const areaFilterEl = document.getElementById("areaFilter");
    const surveyStatusFilterEl = document.getElementById("surveyStatusFilter");
    const searchInputEl = document.getElementById("searchInput");
    const activeFiltersDisplayEl = document.getElementById("activeFiltersDisplay");
    const mapModeToggleEl = document.getElementById("mapModeToggle");
    const lastUpdatedTextEl = document.getElementById("lastUpdatedText");
    const insightsTextEl = document.getElementById("insightsText");

    const totalJunctionsEl = document.getElementById("totalJunctions");
    const surveyedJunctionsEl = document.getElementById("surveyedJunctions");
    const pendingJunctionsEl = document.getElementById("pendingJunctions");
    const surveyedPercentageEl = document.getElementById("surveyedPercentage");
    const pendingPercentageEl = document.getElementById("pendingPercentage");
    const sitesVisitedEl = document.getElementById("sitesVisited");
    const dohaJunctionsEl = document.getElementById("dohaJunctions");
    const dohaSurveyTextEl = document.getElementById("dohaSurveyText");
    const dohaSurveyPercentageEl = document.getElementById("dohaSurveyPercentage");
    const northJunctionsEl = document.getElementById("northJunctions");
    const northSurveyTextEl = document.getElementById("northSurveyText");
    const northSurveyPercentageEl = document.getElementById("northSurveyPercentage");

    function isTrueLike(value) {
      if (value === null || value === undefined) return false;
      const v = String(value).trim().toLowerCase();
      return v === "true" || v === "1" || v === "yes" || v === "y";
    }

    function getSurveyStatus(row) {
      const polesSurvey = isTrueLike(row["Poles Survey"] || row["PolesSurvey"]);
      const controllerSurvey = isTrueLike(row["Controller Survey"] || row["ControllerSurvey"]);
      return (polesSurvey || controllerSurvey) ? "Completed" : "Pending";
    }

    function parseRegion(value) {
      const v = (value || "").toString().toLowerCase();
      if (v.includes("doha")) return "Doha Region";
      if (v.includes("north")) return "North Region";
      return value || "";
    }

    function updateLastUpdatedText() {
      const now = new Date();
      lastUpdatedTextEl.textContent = now.toLocaleString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    }

    function loadData() {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          allRows = results.data.map((row) => {
            const region = parseRegion(row["Region"]);
            return {
              ...row,
              _RegionParsed: region,
              _SurveyStatus: getSurveyStatus(row),
            };
          });
          initFilters();
          applyFilters();
          updateLastUpdatedText();
        },
      });
    }

    function initFilters() {
      const municipalities = new Set();
      const areas = new Set();

      allRows.forEach((row) => {
        if (row["Municipality"]) municipalities.add(row["Municipality"]);
        if (row["Area"]) areas.add(row["Area"]);
      });

      Array.from(municipalities)
        .sort()
        .forEach((m) => {
          const option = document.createElement("option");
          option.value = m;
          option.textContent = m;
          municipalityFilterEl.appendChild(option);
        });

      Array.from(areas)
        .sort()
        .forEach((a) => {
          const option = document.createElement("option");
          option.value = a;
          option.textContent = a;
          areaFilterEl.appendChild(option);
        });

      municipalityFilterEl.addEventListener("change", applyFilters);
      regionFilterEl.addEventListener("change", applyFilters);
      areaFilterEl.addEventListener("change", applyFilters);
      surveyStatusFilterEl.addEventListener("change", applyFilters);
      searchInputEl.addEventListener("input", applyFilters);

      document.getElementById("downloadBtn").addEventListener("click", downloadFilteredCSV);
      mapModeToggleEl.addEventListener("click", toggleMapMode);
    }

    function getFiltersDescription() {
      const filters = [];

      const municipality = municipalityFilterEl.value;
      const region = regionFilterEl.value;
      const area = areaFilterEl.value;
      const status = surveyStatusFilterEl.value;
      const search = searchInputEl.value.trim();

      if (municipality !== "All") filters.push(`Municipality: ${municipality}`);
      if (region !== "All") filters.push(`Region: ${region}`);
      if (area !== "All") filters.push(`Area: ${area}`);
      if (status !== "All") filters.push(`Survey: ${status}`);
      if (search) filters.push(`Search: "${search}"`);

      return filters;
    }

    function updateActiveFiltersDisplay() {
      const filters = getFiltersDescription();

      if (!filters.length) {
        activeFiltersDisplayEl.textContent = "No filters applied.";
        return;
      }

      activeFiltersDisplayEl.innerHTML = "";
      filters.forEach((f) => {
        const span = document.createElement("span");
        span.textContent = f;
        activeFiltersDisplayEl.appendChild(span);
      });
    }

    function applyFilters() {
      const municipality = municipalityFilterEl.value;
      const region = regionFilterEl.value;
      const area = areaFilterEl.value;
      const status = surveyStatusFilterEl.value;
      const searchText = searchInputEl.value.trim().toLowerCase();

      filteredRows = allRows.filter((row) => {
        if (municipality !== "All" && row["Municipality"] !== municipality) return false;
        if (region !== "All" && row._RegionParsed !== region) return false;
        if (area !== "All" && row["Area"] !== area) return false;
        if (status !== "All" && row._SurveyStatus !== status) return false;

        if (searchText) {
          const haystack = (
            (row["Junction No"] || "") +
            " " +
            (row["Junction Name"] || "") +
            " " +
            (row["Municipality"] || "") +
            " " +
            (row["Area"] || "") +
            " " +
            (row["Region"] || "") +
            " " +
            (row["Remarks"] || "")
          ).toLowerCase();
          if (!haystack.includes(searchText)) return false;
        }

        return true;
      });

      updateActiveFiltersDisplay();
      updateSummaryCards();
      updateTable();
      updateMapMarkers();
      updateCharts();
      updateInsights();
    }

    function updateSummaryCards() {
      const total = allRows.length;
      const completedAll = allRows.filter((row) => row._SurveyStatus === "Completed").length;

      const totalFiltered = filteredRows.length;
      const completedFiltered = filteredRows.filter(
        (row) => row._SurveyStatus === "Completed"
      ).length;

      const pendingFiltered = totalFiltered - completedFiltered;
      const surveyedPctFiltered = totalFiltered
        ? (completedFiltered / totalFiltered) * 100
        : 0;
      const pendingPctFiltered = totalFiltered
        ? (pendingFiltered / totalFiltered) * 100
        : 0;

      totalJunctionsEl.textContent = totalFiltered;
      surveyedJunctionsEl.textContent = completedFiltered;
      pendingJunctionsEl.textContent = pendingFiltered;
      surveyedPercentageEl.textContent = `${surveyedPctFiltered.toFixed(1)}%`;
      pendingPercentageEl.textContent = `${pendingPctFiltered.toFixed(1)}%`;

      const visitedSet = new Set();
      allRows.forEach((row) => {
        const polesVisited = isTrueLike(row["Poles Survey"]);
        const controllerVisited = isTrueLike(row["Controller Survey"]);
        if (polesVisited || controllerVisited) {
          visitedSet.add(row["Junction No"]);
        }
      });
      sitesVisitedEl.textContent = visitedSet.size;

      const dohaRows = allRows.filter((row) => row._RegionParsed === "Doha Region");
      const northRows = allRows.filter((row) => row._RegionParsed === "North Region");

      const dohaTotal = dohaRows.length;
      const northTotal = northRows.length;

      const dohaCompleted = dohaRows.filter((row) => row._SurveyStatus === "Completed").length;
      const northCompleted = northRows.filter((row) => row._SurveyStatus === "Completed").length;

      const dohaPct = dohaTotal ? (dohaCompleted / dohaTotal) * 100 : 0;
      const northPct = northTotal ? (northCompleted / northTotal) * 100 : 0;

      dohaJunctionsEl.textContent = dohaTotal;
      northJunctionsEl.textContent = northTotal;

      dohaSurveyTextEl.textContent = `Junctions within Doha Region.`;
      northSurveyTextEl.textContent = `Junctions within North Region.`;

      dohaSurveyPercentageEl.textContent = `${dohaCompleted} / ${dohaTotal} surveyed (${dohaPct.toFixed(
        1
      )}%).`;
      northSurveyPercentageEl.textContent = `${northCompleted} / ${northTotal} surveyed (${northPct.toFixed(
        1
      )}%).`;
    }

    function updateTable() {
      const tbody = document.getElementById("junctionsTableBody");
      tbody.innerHTML = "";

      filteredRows.forEach((row, index) => {
        const tr = document.createElement("tr");

        const srNo = document.createElement("td");
        srNo.textContent = index + 1;
        tr.appendChild(srNo);

        const junctionNo = document.createElement("td");
        junctionNo.textContent = row["Junction No"] || "";
        tr.appendChild(junctionNo);

        const junctionName = document.createElement("td");
        junctionName.textContent = row["Junction Name"] || "";
        tr.appendChild(junctionName);

        const municipality = document.createElement("td");
        municipality.textContent = row["Municipality"] || "";
        tr.appendChild(municipality);

        const region = document.createElement("td");
        const regionPill = document.createElement("span");
        regionPill.className = "zone-pill";
        const dot = document.createElement("span");
        dot.className = "dot";
        regionPill.appendChild(dot);
        const regionText = document.createTextNode(row._RegionParsed || "");
        regionPill.appendChild(regionText);
        region.appendChild(regionPill);
        tr.appendChild(region);

        const area = document.createElement("td");
        area.textContent = row["Area"] || "";
        tr.appendChild(area);

        const surveyStatusTd = document.createElement("td");
        const surveyBadge = document.createElement("span");
        surveyBadge.classList.add("badge");
        if (row._SurveyStatus === "Completed") {
          surveyBadge.classList.add("badge-completed");
          surveyBadge.textContent = "Completed";
        } else {
          surveyBadge.classList.add("badge-pending");
          surveyBadge.textContent = "Pending";
        }
        surveyStatusTd.appendChild(surveyBadge);
        tr.appendChild(surveyStatusTd);

        const polesTd = document.createElement("td");
        const polesFlag = isTrueLike(row["Poles Survey"]);
        const polesBadge = document.createElement("span");
        polesBadge.className = "badge " + (polesFlag ? "badge-completed" : "badge-neutral");
        polesBadge.textContent = polesFlag ? "Visited" : "Not Visited";
        polesTd.appendChild(polesBadge);
        tr.appendChild(polesTd);

        const controllerTd = document.createElement("td");
        const controllerFlag = isTrueLike(row["Controller Survey"]);
        const controllerBadge = document.createElement("span");
        controllerBadge.className =
          "badge " + (controllerFlag ? "badge-completed" : "badge-neutral");
        controllerBadge.textContent = controllerFlag ? "Visited" : "Not Visited";
        controllerTd.appendChild(controllerBadge);
        tr.appendChild(controllerTd);

        const cctvTd = document.createElement("td");
        const cctvFlag = isTrueLike(row["CCTV"]);
        const cctvBadge = document.createElement("span");
        cctvBadge.className = "badge " + (cctvFlag ? "badge-completed" : "badge-neutral");
        cctvBadge.textContent = cctvFlag ? "Yes" : "No";
        cctvTd.appendChild(cctvBadge);
        tr.appendChild(cctvTd);

        const remarksTd = document.createElement("td");
        remarksTd.textContent = row["Remarks"] || "";
        tr.appendChild(remarksTd);

        tr.addEventListener("click", () => {
          zoomToJunction(row);
        });

        tbody.appendChild(tr);
      });
    }

    function initMap() {
      map = L.map("map").setView([25.285447, 51.53104], 10);

      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Tiles © Esri",
        }
      ).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    function updateMapMarkers() {
      markersLayer.clearLayers();

      if (!filteredRows.length) return;

      const bounds = [];

      filteredRows.forEach((row) => {
        const lat = parseFloat(row["Latitude"]);
        const lng = parseFloat(row["Longitude"]);

        if (!isFinite(lat) || !isFinite(lng)) return;

        const color = row._SurveyStatus === "Completed" ? "#16a34a" : "#dc2626";

        const marker = L.circleMarker([lat, lng], {
          radius: 6,
          color,
          fillColor: color,
          fillOpacity: 0.9,
          weight: 1,
        });

        marker.bindPopup(createPopupContent(row));
        marker.addTo(markersLayer);
        bounds.push([lat, lng]);
      });

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [20, 20] });
      }
    }

    function createPopupContent(row) {
      const junctionNo = row["Junction No"] || "";
      const name = row["Junction Name"] || "";
      const municipality = row["Municipality"] || "";
      const region = row._RegionParsed || "";
      const area = row["Area"] || "";
      const status = row._SurveyStatus;
      const remarks = row["Remarks"] || "";

      return `
        <div style="font-size: 12px;">
          <strong>${junctionNo} - ${name}</strong><br/>
          <strong>Municipality:</strong> ${municipality}<br/>
          <strong>Region:</strong> ${region}<br/>
          <strong>Area:</strong> ${area}<br/>
          <strong>Survey Status:</strong> ${status}<br/>
          <strong>Remarks:</strong> ${remarks || "—"}
        </div>
      `;
    }

    function zoomToJunction(row) {
      const lat = parseFloat(row["Latitude"]);
      const lng = parseFloat(row["Longitude"]);

      if (!isFinite(lat) || !isFinite(lng)) return;

      if (singleSelectionMode) {
        markersLayer.clearLayers();
      }

      const statusColor = row._SurveyStatus === "Completed" ? "#16a34a" : "#dc2626";

      const marker = L.circleMarker([lat, lng], {
        radius: 8,
        color: "#0ea5e9",
        fillColor: "#0ea5e9",
        fillOpacity: 0.95,
        weight: 2,
      }).addTo(markersLayer);

      const statusOutline = L.circleMarker([lat, lng], {
        radius: 11,
        color: statusColor,
        fillOpacity: 0,
        weight: 2,
      }).addTo(markersLayer);

      marker.bindPopup(createPopupContent(row)).openPopup();

      map.setView([lat, lng], 15, { animate: true });
    }

    function toggleMapMode() {
      singleSelectionMode = !singleSelectionMode;
      if (singleSelectionMode) {
        mapModeToggleEl.classList.add("active");
        mapModeToggleEl.textContent = "";
        const spanDot = document.createElement("span");
        spanDot.textContent = "●";
        mapModeToggleEl.appendChild(spanDot);
        mapModeToggleEl.appendChild(document.createTextNode("Single Junction Focus"));
        updateMapMarkers();
      } else {
        mapModeToggleEl.classList.remove("active");
        mapModeToggleEl.textContent = "";
        const spanDot = document.createElement("span");
        spanDot.textContent = "◎";
        mapModeToggleEl.appendChild(spanDot);
        mapModeToggleEl.appendChild(document.createTextNode("All Filtered Junctions"));
        updateMapMarkers();
      }
    }

    function updateCharts() {
      const regionGroups = {
        "Doha Region": { Completed: 0, Pending: 0 },
        "North Region": { Completed: 0, Pending: 0 },
      };

      filteredRows.forEach((row) => {
        const region = row._RegionParsed || "Unknown";
        const status = row._SurveyStatus;

        if (!regionGroups[region]) {
          regionGroups[region] = { Completed: 0, Pending: 0 };
        }

        regionGroups[region][status] = (regionGroups[region][status] || 0) + 1;
      });

      const regionLabels = Object.keys(regionGroups);
      const regionCompletedData = regionLabels.map(
        (r) => regionGroups[r].Completed || 0
      );
      const regionPendingData = regionLabels.map(
        (r) => regionGroups[r].Pending || 0
      );

      const municipalityGroups = {};
      filteredRows.forEach((row) => {
        const m = row["Municipality"] || "Unknown";
        if (!municipalityGroups[m]) {
          municipalityGroups[m] = { Completed: 0, Pending: 0 };
        }
        municipalityGroups[m][row._SurveyStatus] =
          (municipalityGroups[m][row._SurveyStatus] || 0) + 1;
      });

      const allMunicipalityEntries = Object.entries(municipalityGroups);
      allMunicipalityEntries.sort((a, b) => {
        const totalA = (a[1].Completed || 0) + (a[1].Pending || 0);
        const totalB = (b[1].Completed || 0) + (b[1].Pending || 0);
        return totalB - totalA;
      });
      const topMunicipalities = allMunicipalityEntries.slice(0, 6);
      const municipalityLabels = topMunicipalities.map((entry) => entry[0]);
      const municipalityCompletedData = topMunicipalities.map(
        (entry) => entry[1].Completed || 0
      );
      const municipalityPendingData = topMunicipalities.map(
        (entry) => entry[1].Pending || 0
      );

      if (regionStatusChart) {
        regionStatusChart.destroy();
      }
      if (municipalityStatusChart) {
        municipalityStatusChart.destroy();
      }

      const regionCtx = document
        .getElementById("regionStatusChart")
        .getContext("2d");
      regionStatusChart = new Chart(regionCtx, {
        type: "bar",
        data: {
          labels: regionLabels,
          datasets: [
            {
              label: "Completed",
              data: regionCompletedData,
              backgroundColor: "rgba(34, 197, 94, 0.9)",
            },
            {
              label: "Pending",
              data: regionPendingData,
              backgroundColor: "rgba(239, 68, 68, 0.9)",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: "#111827",
                font: { size: 11 },
              },
            },
          },
          scales: {
            x: {
              ticks: {
                color: "#111827",
                font: { size: 10 },
              },
              grid: {
                color: "rgba(148, 163, 184, 0.35)",
              },
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: "#111827",
                font: { size: 10 },
              },
              grid: {
                color: "rgba(148, 163, 184, 0.35)",
              },
            },
          },
        },
      });

      const municipalityCtx = document
        .getElementById("municipalityStatusChart")
        .getContext("2d");
      municipalityStatusChart = new Chart(municipalityCtx, {
        type: "bar",
        data: {
          labels: municipalityLabels,
          datasets: [
            {
              label: "Completed",
              data: municipalityCompletedData,
              backgroundColor: "rgba(37, 99, 235, 0.9)",
            },
            {
              label: "Pending",
              data: municipalityPendingData,
              backgroundColor: "rgba(251, 191, 36, 0.95)",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: "#111827",
                font: { size: 11 },
              },
            },
          },
          scales: {
            x: {
              ticks: {
                color: "#111827",
                font: { size: 10 },
              },
              grid: {
                color: "rgba(148, 163, 184, 0.35)",
              },
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: "#111827",
                font: { size: 10 },
              },
              grid: {
                color: "rgba(148, 163, 184, 0.35)",
              },
            },
          },
        },
      });
    }

    function updateInsights() {
      if (!filteredRows.length) {
        insightsTextEl.textContent =
          "No junctions match the current filters. Adjust filters or clear search.";
        return;
      }

      const total = filteredRows.length;
      const completed = filteredRows.filter(
        (row) => row._SurveyStatus === "Completed"
      ).length;
      const pending = total - completed;
      const completionRate = total ? (completed / total) * 100 : 0;

      const dohaFiltered = filteredRows.filter(
        (row) => row._RegionParsed === "Doha Region"
      );
      const northFiltered = filteredRows.filter(
        (row) => row._RegionParsed === "North Region"
      );

      const dohaCompletion =
        dohaFiltered.length &&
        (dohaFiltered.filter((r) => r._SurveyStatus === "Completed").length /
          dohaFiltered.length) *
        100;

      const northCompletion =
        northFiltered.length &&
        (northFiltered.filter((r) => r._SurveyStatus === "Completed").length /
          northFiltered.length) *
        100;

      let regionInsight = "";
      if (dohaFiltered.length && northFiltered.length) {
        if (dohaCompletion > northCompletion) {
          regionInsight = `Doha Region currently has higher survey coverage (${dohaCompletion.toFixed(
            1
          )}%) than North Region (${northCompletion.toFixed(1)}%).`;
        } else if (northCompletion > dohaCompletion) {
          regionInsight = `North Region currently has higher survey coverage (${northCompletion.toFixed(
            1
          )}%) than Doha Region (${dohaCompletion.toFixed(1)}%).`;
        } else {
          regionInsight = `Doha and North Region have equal survey coverage (${dohaCompletion.toFixed(
            1
          )}%).`;
        }
      }

      const municipalityGroups = {};
      filteredRows.forEach((row) => {
        const m = row["Municipality"] || "Unknown";
        if (!municipalityGroups[m]) {
          municipalityGroups[m] = { total: 0, pending: 0 };
        }
        municipalityGroups[m].total++;
        if (row._SurveyStatus === "Pending") municipalityGroups[m].pending++;
      });

      const municipalityArray = Object.entries(municipalityGroups).map(
        ([name, stats]) => ({
          name,
          total: stats.total,
          pending: stats.pending,
          pendingRatio: stats.total ? stats.pending / stats.total : 0,
        })
      );

      municipalityArray.sort((a, b) => b.pendingRatio - a.pendingRatio);
      const topMunicipality = municipalityArray[0];

      let municipalityInsight = "";
      if (topMunicipality && topMunicipality.pending > 0) {
        municipalityInsight = `Highest pending ratio is in ${topMunicipality.name} (${topMunicipality.pending}/${topMunicipality.total} pending).`;
      }

      insightsTextEl.innerHTML = `
        <div><strong>Total Junctions (filtered):</strong> ${total}</div>
        <div><strong>Completed:</strong> ${completed} (${completionRate.toFixed(
        1
      )}%), <strong>Pending:</strong> ${pending}</div>
        <div>${regionInsight}</div>
        <div>${municipalityInsight}</div>
      `;
    }

    function downloadFilteredCSV() {
      if (!filteredRows.length) {
        alert("No data to export for the current filters.");
        return;
      }

      const headers = [
        "Sr No",
        "Junction No",
        "Junction Name",
        "Municipality",
        "Region",
        "Area",
        "Latitude",
        "Longitude",
        "Survey Status",
        "Poles Survey",
        "Controller Survey",
        "CCTV",
        "Remarks",
      ];

      const rows = filteredRows.map((row, index) => [
        index + 1,
        row["Junction No"] || "",
        row["Junction Name"] || "",
        row["Municipality"] || "",
        row._RegionParsed || "",
        row["Area"] || "",
        row["Latitude"] || "",
        row["Longitude"] || "",
        row._SurveyStatus || "",
        row["Poles Survey"] || "",
        row["Controller Survey"] || "",
        row["CCTV"] || "",
        (row["Remarks"] || "").replace(/\r?\n/g, " "),
      ]);

      const csvArray = [headers, ...rows];
      const csvContent = csvArray
        .map((r) =>
          r
            .map((field) => {
              const f = field == null ? "" : String(field);
              if (/[",\n]/.test(f)) {
                return '"' + f.replace(/"/g, '""') + '"';
              }
              return f;
            })
            .join(",")
        )
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "traffic_junctions_filtered.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    window.addEventListener("DOMContentLoaded", () => {
      initMap();
      loadData();
    });
  </script>
</body>
</html>