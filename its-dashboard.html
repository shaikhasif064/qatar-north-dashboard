<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qatar North ITS Survey Dashboard</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  
</head>

<body>
<div class="container"><nav style="padding: 10px 20px; background-color: #f8f9fa; border-bottom: 1px solid #ddd; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; gap: 15px;">
  <a href="index.html" style="color: #004080; text-decoration: none; font-weight: 600; font-size: 16px;">Traffic Dashboard</a>
  <a href="its-dashboard.html" style="color: #004080; text-decoration: none; font-weight: 600; font-size: 16px;">ITS Dashboard</a>
</nav>
<style>
a:hover {
  text-decoration: underline;
  color: #007bff;
  transition: color 0.3s ease;
}
body {
  padding-top: 0;
  background: #ffffff;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #212529;
  line-height: 1.5;
}
h1, h2, h3, h4, h5, h6 {
  color: #004080;
}
button, .btn {
  background: #004080;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.3s ease;
}
button:hover, .btn:hover {
  background: #0056b3;
}
.card {
  background: #fefefe;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 12px rgb(0 0 0 / 0.1);
  border-radius: 8px;
}
</style>

  <div class="page">
    <div class="shell">
      <!-- HEADER -->
      <header>
        <div class="header-left">
          <img src="aktor-logo.png" alt="Aktor Qatar" class="header-logo" />
        </div>

        <div class="header-center">
          <div class="header-title">Qatar North ITS Survey Dashboard</div>
          <div class="header-subtitle">
            Traffic Junctions · ITS Devices &amp; Systems
          </div>
          <div class="header-meta">
            Live from Google Sheet — assets, survey completion &amp; location overview ·
            <span id="last-updated">Loading…</span>
          </div>
        </div>

        <div class="header-right">
          <img
            src="algosystems-logo.png"
            alt="Algosystems"
            class="header-logo header-logo-small"
          />
        </div>
      </header>

      <main class="dashboard">
        <!-- KPI GRID -->
        <section class="section section-kpis">
          <div class="kpi-grid">
            <!-- TOTAL ASSETS -->
            <div class="kpi-card">
              <div class="kpi-label">Total ITS Assets</div>
              <div class="kpi-value" id="total-assets-count">–</div>
            </div>

            <!-- ASSETS SURVEYED -->
            <div class="kpi-card">
              <div class="kpi-label">Assets Surveyed</div>
              <div class="kpi-value" id="assets-surveyed-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-survey-fill" class="circle-fill"></div>
                  <div id="circle-survey-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-survey-pct">0%</strong> of ITS assets surveyed
                  </div>
                  <div class="kpi-pct" id="survey-completion-text">–</div>
                </div>
              </div>
            </div>

            <!-- SURVEY COMPLETION % (global) -->
            <div class="kpi-card">
              <div class="kpi-label">Survey Completion</div>
              <div class="kpi-value" id="survey-completion-percent">–</div>
              <!-- Circle already above in Assets Surveyed card, so here just a text summary -->
              <div class="kpi-subtext">
                Overall completion rate for all ITS assets in the current filter.
              </div>
            </div>

            <!-- PENDING -->
            <div class="kpi-card">
              <div class="kpi-label">Assets Pending</div>
              <div class="kpi-value" id="assets-pending-count">–</div>
              <div class="kpi-subtext">Assets with survey status “Pending”.</div>
            </div>

            <!-- CCTV -->
            <div class="kpi-card">
              <div class="kpi-label">CCTV Assets</div>
              <div class="kpi-value" id="cctv-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-cctv-fill" class="circle-fill"></div>
                  <div id="circle-cctv-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-cctv-pct">0%</strong> CCTV surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- DMS -->
            <div class="kpi-card">
              <div class="kpi-label">DMS Assets</div>
              <div class="kpi-value" id="dms-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-dms-fill" class="circle-fill"></div>
                  <div id="circle-dms-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-dms-pct">0%</strong> DMS surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- RVD -->
            <div class="kpi-card">
              <div class="kpi-label">RVD Assets</div>
              <div class="kpi-value" id="rvd-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-rvd-fill" class="circle-fill"></div>
                  <div id="circle-rvd-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-rvd-pct">0%</strong> RVD surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- PTZ -->
            <div class="kpi-card">
              <div class="kpi-label">PTZ Assets</div>
              <div class="kpi-value" id="ptz-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-ptz-fill" class="circle-fill"></div>
                  <div id="circle-ptz-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-ptz-pct">0%</strong> PTZ surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- LPR -->
            <div class="kpi-card">
              <div class="kpi-label">LPR Assets</div>
              <div class="kpi-value" id="lpr-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-lpr-fill" class="circle-fill"></div>
                  <div id="circle-lpr-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-lpr-pct">0%</strong> LPR surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- AID -->
            <div class="kpi-card">
              <div class="kpi-label">AID Assets</div>
              <div class="kpi-value" id="aid-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-aid-fill" class="circle-fill"></div>
                  <div id="circle-aid-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-aid-pct">0%</strong> AID surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- OVDS -->
            <div class="kpi-card">
              <div class="kpi-label">OVDS Assets</div>
              <div class="kpi-value" id="ovds-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-ovds-fill" class="circle-fill"></div>
                  <div id="circle-ovds-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-ovds-pct">0%</strong> OVDS surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- RWIS -->
            <div class="kpi-card">
              <div class="kpi-label">RWIS Assets</div>
              <div class="kpi-value" id="rwis-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-rwis-fill" class="circle-fill"></div>
                  <div id="circle-rwis-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-rwis-pct">0%</strong> RWIS surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- LCS -->
            <div class="kpi-card">
              <div class="kpi-label">LCS Assets</div>
              <div class="kpi-value" id="lcs-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-lcs-fill" class="circle-fill"></div>
                  <div id="circle-lcs-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-lcs-pct">0%</strong> LCS surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- AQMS -->
            <div class="kpi-card">
              <div class="kpi-label">AQMS Assets</div>
              <div class="kpi-value" id="aqms-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-aqms-fill" class="circle-fill"></div>
                  <div id="circle-aqms-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-aqms-pct">0%</strong> AQMS surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- Magnetometer AP -->
            <div class="kpi-card">
              <div class="kpi-label">Magnetometer AP</div>
              <div class="kpi-value" id="magap-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-magap-fill" class="circle-fill"></div>
                  <div id="circle-magap-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-magap-pct">0%</strong> AP surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- Magnetometer Dots -->
            <div class="kpi-card">
              <div class="kpi-label">Magnetometer Dots</div>
              <div class="kpi-value" id="magdot-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-magdot-fill" class="circle-fill"></div>
                  <div id="circle-magdot-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-magdot-pct">0%</strong> Dots surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- WIM Sensor -->
            <div class="kpi-card">
              <div class="kpi-label">WIM Sensor</div>
              <div class="kpi-value" id="wim-sensor-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-wim-sensor-fill" class="circle-fill"></div>
                  <div id="circle-wim-sensor-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-wim-sensor-pct">0%</strong> Sensors surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- WIM Controller -->
            <div class="kpi-card">
              <div class="kpi-label">WIM Controller</div>
              <div class="kpi-value" id="wim-controller-assets-count">–</div>
              <div class="kpi-circle-layout kpi-circle-compact">
                <div class="circle-wrapper">
                  <div id="circle-wim-controller-fill" class="circle-fill"></div>
                  <div id="circle-wim-controller-inner" class="circle-inner">0 / 0</div>
                </div>
                <div class="kpi-circle-text">
                  <div class="circle-caption">
                    <strong id="circle-wim-controller-pct">0%</strong> Controllers surveyed
                  </div>
                </div>
              </div>
            </div>

            <!-- REGION COUNTS (no circles, just numbers) -->
            <div class="kpi-card">
              <div class="kpi-label">Assets in Doha Region</div>
              <div class="kpi-value" id="assets-doha-count">–</div>
            </div>

            <div class="kpi-card">
              <div class="kpi-label">Assets in North Region</div>
              <div class="kpi-value" id="assets-north-count">–</div>
            </div>
          </div>
        </section>

        <!-- INSIGHTS BAR -->
        <section class="section section-insights">
          <div class="glass-card">
            <div class="insights-bar">
              <div class="insights-main-label">
                <span class="badge-pulse"></span>
                <span>Device Types Needing Attention</span>
              </div>
              <div id="device-insights" class="card-sub"></div>
            </div>
          </div>
        </section>

        <!-- FILTERS -->
        <section class="section section-filters">
          <div class="glass-card filters-card">
            <div class="filters-row-title">Filters</div>
            <div class="filters">
              <label>
                Zone Area
                <select id="zoneAreaFilter">
                  <option value="All">All</option>
                </select>
              </label>
              <label>
                Device Type
                <select id="deviceTypeFilter">
                  <option value="All">All</option>
                </select>
              </label>
              <label>
                Survey Status
                <select id="surveyStatusFilter">
                  <option value="All">All</option>
                  <option value="Completed">Completed</option>
                  <option value="Pending">Pending</option>
                </select>
              </label>
            </div>

            <div class="filters-row-extra">
              <div class="filters-note">No filters applied.</div>
              <button id="downloadBtn" class="export-btn">
                Download Current View (CSV)
              </button>
            </div>
          </div>
        </section>

        <!-- MAP + CHARTS -->
        <section class="section section-main">
          <div class="main-grid">
            <div class="glass-card map-card">
              <div class="map-card-header">
                <div class="map-title">
                  <span class="dot"></span>
                  <span>ITS Assets Map (Satellite Imagery)</span>
                </div>
                <button
                  id="mapModeToggle"
                  class="map-toggle-btn map-toggle-btn-active"
                  type="button"
                >
                  Map Mode: Selected Asset Only
                </button>
              </div>
              <div id="map"></div>
              <div class="map-footer" id="map-footer">
                ESRI World Imagery showing surveyed (green) and pending (red) ITS
                assets in Qatar North. Map respects current filters and search.
              </div>
            </div>

            <div class="charts-stack">
              <div class="glass-card chart-card">
                <p class="chart-title">Assets by Device Type</p>
                <div class="chart-wrapper">
                  <canvas id="deviceTypeChart"></canvas>
                </div>
                <div class="chart-legend" id="chart-legend">
                  Distribution of ITS assets by device type for the current selection.
                </div>
              </div>

              <div class="glass-card chart-card">
                <p class="chart-title">Survey Completion % by Device Type</p>
                <div class="chart-wrapper">
                  <canvas id="deviceCompletionChart"></canvas>
                </div>
                <div class="chart-legend" id="completion-legend">
                  Percentage of surveyed devices for each device type.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- TABLE -->
        <section class="section section-table">
          <div class="glass-card table-card">
            <div class="table-header-row">
              <div class="table-header-left">
                <div class="table-header-title">ITS Asset List</div>
                <div class="table-header-sub">
                  Tap a row to highlight on map. Search by ID, Name, Device Type, Zone Area, Zone, or Remarks.
                </div>
              </div>
            </div>

            <div class="table-controls">
              <div class="table-search">
                <input
                  type="text"
                  id="assetSearch"
                  placeholder="Start typing to filter the ITS asset list..."
                />
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th style="width: 55px">Sr. No.</th>
                    <th style="width: 70px">ID</th>
                    <th>Name</th>
                    <th>Device Type</th>
                    <th>Zone Area</th>
                    <th>Zone</th>
                    <th>Survey</th>
                    <th>Remarks</th>
                  </tr>
                </thead>
                <tbody id="asset-table-body"></tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // === CONFIG ==========================================================
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5yrlBZ6pktog25ogVRyoi6XkGGt9nUMjGaiCjGRmCEG82EZKTa8XHecxBpAmuPBcaZQ-0BiIlb4_w/pub?gid=1191966534&single=true&output=csv";

    // === GLOBAL STATE ====================================================
    let allAssets = [];
    let filteredAssets = [];

    let map;
    let markerLayer;
    let deviceTypeChart;
    let deviceCompletionChart;

    // map mode: true = selected asset only (clear others on click)
    let singleSelectionMode = true;

    // === UTILITIES =======================================================

    function normalizeDeviceType(raw) {
      const s = (raw || "").toString().trim().toLowerCase();
      if (!s) return "";

      if (s === "dms" || s.includes("dms")) return "DMS";
      if (s === "rvd") return "RVD";
      if (s.includes("ptz")) return "PTZ";
      if (s.includes("lpr")) return "LPR";
      if (s.includes("aid")) return "AID";
      if (s.includes("ovds") || s.includes("overheight") || s.includes("over height"))
        return "OVDS";
      if (s.includes("rwis") || s.includes("weather")) return "RWIS";
      if (s.includes("wim") && s.includes("sensor")) return "WIM Sensor";
      if (s.includes("wim") && s.includes("controller")) return "WIM Controller";
      if (s.includes("mag") && s.includes("ap")) return "Magnetometer AP";
      if (s.includes("mag") && (s.includes("dot") || s.includes("detector")))
        return "Magnetometer Dots";
      if (s.includes("lcs") || s.includes("lane control"))
        return "LCS";
      if (s.includes("aqm") || s.includes("aqms") || s.includes("air quality"))
        return "AQMS";

      if (s.includes("cctv")) return "CCTV";

      return raw || "";
    }

    function normalizeZoneArea(rawZoneArea) {
      const txt = (rawZoneArea || "").toString().trim();
      const lower = txt.toLowerCase();
      if (lower.includes("doha")) return "Doha Region";
      if (lower.includes("north")) return "North Region";
      return txt || "";
    }

    function formatPercent(value) {
      if (!isFinite(value)) return "0.0%";
      return value.toFixed(1) + "%";
    }

    function setLastUpdated() {
      const span = document.getElementById("last-updated");
      const now = new Date();
      span.textContent = now.toLocaleString("en-GB", {
        weekday: "short",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });
    }

    // Circular KPI updater (same logic as Traffic dashboard)
    function updateCircularKpi({ fillId, innerId, pctId, numerator, denominator, pct }) {
      const fillEl = document.getElementById(fillId);
      const innerEl = document.getElementById(innerId);
      const pctEl = document.getElementById(pctId);

      const safeNum = Number.isFinite(numerator) ? numerator : 0;
      const safeDen = Number.isFinite(denominator) ? denominator : 0;
      const safePct = Number.isFinite(pct) && pct >= 0
        ? Math.max(0, Math.min(100, pct))
        : 0;

      if (fillEl) {
        const angle = (safePct / 100) * 360;
        fillEl.style.background =
          `conic-gradient(#22c55e 0deg ${angle}deg, rgba(15,23,42,0.45) ${angle}deg 360deg)`;
      }
      if (innerEl) {
        innerEl.textContent = safeDen > 0 ? `${safeNum} / ${safeDen}` : `${safeNum} / 0`;
      }
      if (pctEl) {
        pctEl.textContent = `${safePct.toFixed(1)}%`;
      }
    }

    // === DATA LOADING ====================================================

    function loadData() {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const rows = results.data || [];

          allAssets = rows
            .map((row) => {
              const lat = parseFloat(row["Latitude"]);
              const lng = parseFloat(row["Longitude"]);
              if (!isFinite(lat) || !isFinite(lng)) return null;

              const rawArea =
                row["Zone Area"] || row["Area"] || row["Zone"] || "";
              const zoneArea = normalizeZoneArea(rawArea);

              const surveyStatusRaw =
                (row["Survey Status"] || row["SurveyStatus"] || "").toString().trim().toUpperCase();
              const surveyStatus =
                surveyStatusRaw === "TRUE" || surveyStatusRaw === "COMPLETED"
                  ? "Completed"
                  : "Pending";

              const deviceType = normalizeDeviceType(row["Device Type"]);

              return {
                id: row["ID"],
                name: row["Name"],
                latitude: lat,
                longitude: lng,
                zoneArea,
                zone: row["Zone"] || "",
                deviceType,
                surveyStatus,
                remarks: row["Remarks from Survey Team"] || row["Remarks"] || ""
              };
            })
            .filter(Boolean);

          initFilters();
          applyFilters();
          setLastUpdated();
        }
      });
    }

    // === FILTERS & SEARCH ===============================================

    function initFilters() {
      const zoneAreaSelect = document.getElementById("zoneAreaFilter");
      const deviceTypeSelect = document.getElementById("deviceTypeFilter");

      const zoneAreas = Array.from(
        new Set(allAssets.map((a) => a.zoneArea).filter((x) => x))
      ).sort();

      zoneAreas.forEach((za) => {
        const opt = document.createElement("option");
        opt.value = za;
        opt.textContent = za;
        zoneAreaSelect.appendChild(opt);
      });

      const deviceTypes = Array.from(
        new Set(allAssets.map((a) => a.deviceType).filter((x) => x))
      ).sort();

      deviceTypes.forEach((dt) => {
        const opt = document.createElement("option");
        opt.value = dt;
        opt.textContent = dt;
        deviceTypeSelect.appendChild(opt);
      });

      zoneAreaSelect.addEventListener("change", applyFilters);
      deviceTypeSelect.addEventListener("change", applyFilters);
      document
        .getElementById("surveyStatusFilter")
        .addEventListener("change", applyFilters);
      document
        .getElementById("assetSearch")
        .addEventListener("input", applyFilters);
      document
        .getElementById("downloadBtn")
        .addEventListener("click", downloadCurrentView);

      const toggleBtn = document.getElementById("mapModeToggle");
      if (toggleBtn) {
        toggleBtn.addEventListener("click", () => {
          singleSelectionMode = !singleSelectionMode;
          updateMapModeButton();
          if (!singleSelectionMode) {
            // switching to "All Filtered Assets" – redraw full set
            updateMap(filteredAssets);
          }
        });
        updateMapModeButton();
      }
    }

    function updateMapModeButton() {
      const btn = document.getElementById("mapModeToggle");
      if (!btn) return;
      if (singleSelectionMode) {
        btn.textContent = "Map Mode: Selected Asset Only";
        btn.classList.add("map-toggle-btn-active");
      } else {
        btn.textContent = "Map Mode: All Filtered Assets";
        btn.classList.remove("map-toggle-btn-active");
      }
    }

    function applyFilters() {
      const zoneAreaValue = document.getElementById("zoneAreaFilter").value;
      const deviceTypeValue = document.getElementById("deviceTypeFilter").value;
      const surveyStatusValue =
        document.getElementById("surveyStatusFilter").value;
      const searchText = document
        .getElementById("assetSearch")
        .value.toLowerCase()
        .trim();

      filteredAssets = allAssets.filter((asset) => {
        if (zoneAreaValue !== "All" && asset.zoneArea !== zoneAreaValue)
          return false;
        if (deviceTypeValue !== "All" && asset.deviceType !== deviceTypeValue)
          return false;
        if (
          surveyStatusValue !== "All" &&
          asset.surveyStatus !== surveyStatusValue
        )
          return false;

        if (!searchText) return true;

        const haystack = (
          asset.id +
          " " +
          asset.name +
          " " +
          asset.deviceType +
          " " +
          asset.zoneArea +
          " " +
          asset.zone +
          " " +
          asset.remarks
        )
          .toLowerCase()
          .trim();

        return haystack.includes(searchText);
      });

      updateSummaryCards(filteredAssets);
      updateMap(filteredAssets);
      updateTable(filteredAssets);
      updateDeviceCharts(filteredAssets);
      updateFiltersNote();
    }

    function updateFiltersNote() {
      const zoneAreaValue = document.getElementById("zoneAreaFilter").value;
      const deviceTypeValue = document.getElementById("deviceTypeFilter").value;
      const surveyStatusValue =
        document.getElementById("surveyStatusFilter").value;
      const searchText = document
        .getElementById("assetSearch")
        .value.toLowerCase()
        .trim();

      const active = [];

      if (zoneAreaValue !== "All") active.push("Zone Area: " + zoneAreaValue);
      if (deviceTypeValue !== "All")
        active.push("Device Type: " + deviceTypeValue);
      if (surveyStatusValue !== "All")
        active.push("Survey: " + surveyStatusValue);
      if (searchText) active.push("Search text");

      const noteEl = document.querySelector(".filters-note");
      if (!active.length) {
        noteEl.textContent = "No filters applied.";
      } else {
        noteEl.textContent = "Active filters — " + active.join(" · ");
      }
    }

    // === SUMMARY CARDS & CIRCLES ========================================

    function deviceStats(assets, canonicalType) {
      const matching = assets.filter((a) => a.deviceType === canonicalType);
      const total = matching.length;
      const completed = matching.filter(
        (a) => a.surveyStatus === "Completed"
      ).length;
      const percent = total ? (completed / total) * 100 : 0;
      return { total, completed, percent };
    }

    function setCircleStats(prefix, stats) {
      const { total, completed, percent } = stats;

      // main count number
      const countEl = document.getElementById(`${prefix}-assets-count`);
      if (countEl) countEl.textContent = total.toString();

      // circle
      updateCircularKpi({
        fillId: `circle-${prefix}-fill`,
        innerId: `circle-${prefix}-inner`,
        pctId: `circle-${prefix}-pct`,
        numerator: completed,
        denominator: total,
        pct: percent
      });
    }

    function updateSummaryCards(assets) {
      const total = assets.length;
      const surveyed = assets.filter(
        (a) => a.surveyStatus === "Completed"
      ).length;
      const pending = total - surveyed;
      const completionPct = total ? (surveyed / total) * 100 : 0;

      document.getElementById("total-assets-count").textContent = total;
      document.getElementById("assets-surveyed-count").textContent = surveyed;
      document.getElementById("assets-pending-count").textContent = pending;

      document.getElementById("survey-completion-percent").textContent =
        formatPercent(completionPct);
      document.getElementById("survey-completion-text").textContent =
        surveyed +
        " of " +
        total +
        " ITS assets surveyed (" +
        formatPercent(completionPct) +
        ").";

      // global circle
      updateCircularKpi({
        fillId: "circle-survey-fill",
        innerId: "circle-survey-inner",
        pctId: "circle-survey-pct",
        numerator: surveyed,
        denominator: total,
        pct: completionPct
      });

      const assetsDoha = assets.filter((a) =>
        a.zoneArea.toLowerCase().includes("doha")
      ).length;
      const assetsNorth = assets.filter((a) =>
        a.zoneArea.toLowerCase().includes("north")
      ).length;

      document.getElementById("assets-doha-count").textContent = assetsDoha;
      document.getElementById("assets-north-count").textContent = assetsNorth;

      // device circles
      setCircleStats("cctv", deviceStats(assets, "CCTV"));
      setCircleStats("dms", deviceStats(assets, "DMS"));
      setCircleStats("rvd", deviceStats(assets, "RVD"));
      setCircleStats("ptz", deviceStats(assets, "PTZ"));
      setCircleStats("lpr", deviceStats(assets, "LPR"));
      setCircleStats("aid", deviceStats(assets, "AID"));
      setCircleStats("ovds", deviceStats(assets, "OVDS"));
      setCircleStats("rwis", deviceStats(assets, "RWIS"));
      setCircleStats("lcs", deviceStats(assets, "LCS"));
      setCircleStats("aqms", deviceStats(assets, "AQMS"));
      setCircleStats("magap", deviceStats(assets, "Magnetometer AP"));
      setCircleStats("magdot", deviceStats(assets, "Magnetometer Dots"));
      setCircleStats("wim-sensor", deviceStats(assets, "WIM Sensor"));
      setCircleStats("wim-controller", deviceStats(assets, "WIM Controller"));
    }

    // === MAP =============================================================

    function initMap() {
      map = L.map("map", {
        center: [25.35, 51.45],
        zoom: 9
      });

      // ESRI World Imagery (same as Traffic dashboard)
      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics"
        }
      ).addTo(map);

      markerLayer = L.layerGroup().addTo(map);
    }

    function buildPopupHtml(asset) {
      return `
        <strong>${asset.id || ""} - ${asset.name || ""}</strong><br/>
        <strong>Device:</strong> ${asset.deviceType || ""}<br/>
        <strong>Zone Area:</strong> ${asset.zoneArea || ""}<br/>
        <strong>Zone:</strong> ${asset.zone || ""}<br/>
        <strong>Survey:</strong> ${asset.surveyStatus}<br/>
        <strong>Remarks:</strong> ${asset.remarks || "—"}
      `;
    }

    function updateMap(assets) {
      if (!map) initMap();
      markerLayer.clearLayers();

      if (!assets.length) return;

      const bounds = [];

      assets.forEach((asset) => {
        const color =
          asset.surveyStatus === "Completed"
            ? "#16a34a"
            : "#dc2626";

        const marker = L.circleMarker([asset.latitude, asset.longitude], {
          radius: 6,
          color,
          fillColor: color,
          fillOpacity: 0.85,
          weight: 1
        });

        marker.bindPopup(buildPopupHtml(asset));

        marker.addTo(markerLayer);
        bounds.push([asset.latitude, asset.longitude]);
      });

      if (bounds.length > 1) {
        map.fitBounds(bounds, { padding: [20, 20] });
      } else if (bounds.length === 1) {
        map.setView(bounds[0], 13);
      }
    }

    function flyToAsset(asset) {
      if (!map || !asset) return;
      const latlng = [asset.latitude, asset.longitude];

      if (singleSelectionMode) {
        // Show only the selected asset in blue
        markerLayer.clearLayers();
        const marker = L.circleMarker(latlng, {
          radius: 8,
          color: "#38bdf8",
          fillColor: "#38bdf8",
          fillOpacity: 1,
          weight: 2
        }).addTo(markerLayer);
        marker.bindPopup(buildPopupHtml(asset)).openPopup();
      } else {
        // Keep all markers but highlight selected with an extra blue marker
        const marker = L.circleMarker(latlng, {
          radius: 8,
          color: "#38bdf8",
          fillColor: "#38bdf8",
          fillOpacity: 1,
          weight: 2
        }).addTo(markerLayer);
        marker.bindPopup(buildPopupHtml(asset)).openPopup();
      }

      map.setView(latlng, 16, { animate: true });
    }

    // === TABLE ===========================================================

    function updateTable(assets) {
      const tbody = document.getElementById("asset-table-body");
      tbody.innerHTML = "";

      assets.forEach((asset, index) => {
        const tr = document.createElement("tr");

        // Sr. No.
        const tdSr = document.createElement("td");
        tdSr.textContent = index + 1;
        tr.appendChild(tdSr);

        const tdId = document.createElement("td");
        tdId.textContent = asset.id || "";
        tr.appendChild(tdId);

        const tdName = document.createElement("td");
        tdName.textContent = asset.name || "";
        tr.appendChild(tdName);

        const tdDevice = document.createElement("td");
        tdDevice.textContent = asset.deviceType || "";
        tr.appendChild(tdDevice);

        const tdArea = document.createElement("td");
        tdArea.textContent = asset.zoneArea || "";
        tr.appendChild(tdArea);

        const tdZone = document.createElement("td");
        tdZone.textContent = asset.zone || "";
        tr.appendChild(tdZone);

        const tdSurvey = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("badge");
        if (asset.surveyStatus === "Completed") {
          badge.classList.add("badge-success");
          badge.textContent = "Completed";
        } else {
          badge.classList.add("badge-pending");
          badge.textContent = "Pending";
        }
        tdSurvey.appendChild(badge);
        tr.appendChild(tdSurvey);

        const tdRemarks = document.createElement("td");
        tdRemarks.textContent = asset.remarks || "";
        tr.appendChild(tdRemarks);

        // clicking a row moves map to that asset
        tr.addEventListener("click", () => {
          flyToAsset(asset);
        });

        tbody.appendChild(tr);
      });
    }

    // === CHARTS & INSIGHTS ===============================================

    function updateDeviceCharts(assets) {
      const ctxDonut = document
        .getElementById("deviceTypeChart")
        .getContext("2d");
      const ctxBar = document
        .getElementById("deviceCompletionChart")
        .getContext("2d");

      const counts = {};
      const completed = {};

      assets.forEach((a) => {
        const type = a.deviceType || "Unknown";
        counts[type] = (counts[type] || 0) + 1;
        if (a.surveyStatus === "Completed") {
          completed[type] = (completed[type] || 0) + 1;
        }
      });

      const labels = Object.keys(counts);
      const dataCounts = labels.map((l) => counts[l]);
      const dataPct = labels.map((l) =>
        counts[l] ? (completed[l] || 0) / counts[l] * 100 : 0
      );

      if (deviceTypeChart) {
        deviceTypeChart.destroy();
      }
      if (deviceCompletionChart) {
        deviceCompletionChart.destroy();
      }

      deviceTypeChart = new Chart(ctxDonut, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data: dataCounts,
              backgroundColor: [
                "#4f46e5",
                "#0ea5e9",
                "#10b981",
                "#6366f1",
                "#f97316",
                "#ec4899",
                "#a855f7",
                "#22c55e",
                "#eab308",
                "#f97316",
                "#06b6d4",
                "#94a3b8"
              ],
              borderWidth: 0
            }
          ]
        },
        options: {
          plugins: {
            legend: {
              position: "right",
              labels: {
                boxWidth: 10,
                boxHeight: 10,
                font: { size: 10 },
                color: "#e5e7eb"
              }
            }
          },
          maintainAspectRatio: false
        }
      });

      deviceCompletionChart = new Chart(ctxBar, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Survey Completion %",
              data: dataPct,
              backgroundColor: "rgba(34, 197, 94, 0.9)"
            }
          ]
        },
        options: {
          scales: {
            x: {
              ticks: { color: "#e5e7eb" },
              grid: { color: "rgba(55, 65, 81, 0.8)" }
            },
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: (value) => value + "%",
                color: "#e5e7eb"
              },
              title: {
                display: true,
                text: "Completion %",
                color: "#e5e7eb"
              },
              grid: { color: "rgba(55, 65, 81, 0.8)" }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (ctx) =>
                  ctx.parsed.y.toFixed(1) + "% surveyed"
              }
            }
          },
          maintainAspectRatio: false
        }
      });

      document.getElementById("chart-legend").textContent =
        "Showing " +
        assets.length +
        " ITS assets across " +
        labels.length +
        " device type(s) for the current filter selection.";

      document.getElementById("completion-legend").textContent =
        "Bars show the percentage of surveyed devices for each device type.";

      updateDeviceInsights(labels, counts, completed);
    }

    function updateDeviceInsights(labels, counts, completed) {
      const el = document.getElementById("device-insights");
      if (!el) return;

      if (!labels.length) {
        el.textContent = "No data for current selection.";
        return;
      }

      const arr = labels.map((label) => {
        const total = counts[label] || 0;
        const comp = completed[label] || 0;
        const pct = total ? (comp / total) * 100 : 0;
        return { label, total, comp, pct };
      });

      arr.sort((a, b) => a.pct - b.pct);

      const threshold = 60;
      const needing = arr.filter((x) => x.pct < threshold);

      if (!needing.length) {
        el.textContent =
          "All device types have survey completion ≥ " + threshold + "%.";
        return;
      }

      const top5 = needing.slice(0, 5);
      el.innerHTML =
        "<strong>Lowest completion device types (under " +
        threshold +
        "%):</strong><br/>";
      top5.forEach((x) => {
        const line =
          x.label +
          ": " +
          x.comp +
          "/" +
          x.total +
          " (" +
          x.pct.toFixed(1) +
          "%)";
        const div = document.createElement("div");
        div.textContent = line;
        el.appendChild(div);
      });
    }

    // === DOWNLOAD CURRENT VIEW ==========================================

    function downloadCurrentView() {
      if (!filteredAssets.length) {
        alert("No assets in the current view to export.");
        return;
      }

      const csvHeader = [
        "Sr.No",
        "ID",
        "Name",
        "Device Type",
        "Zone Area",
        "Zone",
        "Latitude",
        "Longitude",
        "Survey Status",
        "Remarks"
      ];

      const rows = filteredAssets.map((a, index) => [
        index + 1,
        a.id || "",
        a.name || "",
        a.deviceType || "",
        a.zoneArea || "",
        a.zone || "",
        a.latitude,
        a.longitude,
        a.surveyStatus,
        (a.remarks || "").replace(/\r?\n/g, " ")
      ]);

      const allRows = [csvHeader, ...rows];
      const csvContent = allRows
        .map((r) =>
          r
            .map((field) => {
              const f = field == null ? "" : field.toString();
              if (/[",\n]/.test(f)) {
                return '"' + f.replace(/"/g, '""') + '"';
              }
              return f;
            })
            .join(",")
        )
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "its-dashboard-current-view.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // === INIT ============================================================

    window.addEventListener("DOMContentLoaded", () => {
      initMap();
      loadData();
    });
  </script></div>
</body>
</html>