<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qatar North ITS Survey Dashboard</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #02051b;
      --card-bg: rgba(255, 255, 255, 0.94);
      --card-border: rgba(255, 255, 255, 0.2);
      --accent: #0099ff;
      --accent-soft: #1b6eff;
      --accent-green: #1bbf6b;
      --accent-red: #ff4b5c;
      --accent-orange: #ffb347;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.35);
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      min-height: 100vh;
      background: #02051b url("bg-image.png") no-repeat center top fixed;
      background-size: cover;
      color: #111827;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1700px;
      margin: 0 auto 40px auto;
      padding: 12px 18px 40px 18px;
    }

    header {
      background: linear-gradient(
        90deg,
        rgba(2, 6, 23, 0.96),
        rgba(15, 23, 42, 0.96)
      );
      color: #f9fafb;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 10px 28px 14px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 3px solid #ff375f;
      width: 100%;
    }

    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-logo {
      height: 55px;
      object-fit: contain;
    }

    .header-center {
      text-align: center;
      flex: 1;
    }

    .header-title {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .header-subtitle {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 2px;
    }

    .header-meta {
      font-size: 11px;
      opacity: 0.85;
      margin-top: 4px;
    }

    main {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* KPI cards */

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 14px;
    }

    @media (max-width: 1450px) {
      .kpi-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (max-width: 1024px) {
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }
      header {
        flex-direction: column;
        gap: 8px;
        text-align: center;
      }
      .header-left,
      .header-right {
        justify-content: center;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 12px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--card-border);
      backdrop-filter: blur(8px);
    }

    .kpi-card {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 84px;
    }

    .kpi-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .kpi-value {
      font-size: 26px;
      font-weight: 700;
      color: #111827;
    }

    .kpi-subtext {
      font-size: 11px;
      color: #4b5563;
      margin-top: 4px;
    }

    .progress-track {
      margin-top: 6px;
      height: 5px;
      border-radius: var(--radius-pill);
      background: #e5e7eb;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(
        90deg,
        var(--accent-green),
        var(--accent-soft)
      );
      transition: width 0.4s ease-out;
    }

    .kpi-pct {
      font-size: 11px;
      color: #111827;
      margin-top: 3px;
    }

    /* Filters */

    .filters-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 14px;
      align-items: stretch;
    }

    @media (max-width: 1100px) {
      .filters-row {
        grid-template-columns: 1fr;
      }
    }

    .filters-card {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filters-title {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 2px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      align-items: center;
    }

    @media (max-width: 900px) {
      .filters-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .field-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }

    select,
    input[type="text"] {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid #d1d5db;
      padding: 6px 10px;
      font-size: 12px;
      background: #f9fafb;
      color: #111827;
      outline: none;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
      background: #ffffff;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-pill);
      padding: 7px 16px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      background: linear-gradient(
        90deg,
        var(--accent-soft),
        var(--accent-green)
      );
      color: white;
      cursor: pointer;
      gap: 6px;
      margin-top: 8px;
      align-self: flex-start;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .filters-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* Layout: map + table + charts */

    .layout-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr);
      gap: 14px;
    }

    @media (max-width: 1200px) {
      .layout-row {
        grid-template-columns: 1fr;
      }
    }

    .map-card {
      padding: 10px 10px 6px 10px;
    }

    .map-title,
    .table-title,
    .chart-title {
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: var(--radius-md);
    }

    .map-footer {
      font-size: 10px;
      color: #6b7280;
      margin-top: 4px;
    }

    .table-card {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 440px;
    }

    .table-header-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .search-input {
      font-size: 12px;
    }

    .table-wrapper {
      flex: 1;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #f3f4f6;
      text-align: left;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 6px;
      border-radius: var(--radius-pill);
      font-size: 10px;
      font-weight: 600;
      color: white;
    }

    .badge-success {
      background: #16a34a;
    }

    .badge-pending {
      background: #dc2626;
    }

    .badge-neutral {
      background: #6b7280;
    }

    .bottom-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 14px;
    }

    @media (max-width: 1300px) {
      .bottom-row {
        grid-template-columns: 1fr;
      }
    }

    .chart-card {
      padding: 10px 12px;
    }

    #deviceTypeChart {
      max-height: 280px;
    }

    #deviceCompletionChart {
      max-height: 280px;
    }

    .chart-legend {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="header-left">
        <img src="aktor-logo.png" alt="Aktor Qatar" class="header-logo" />
      </div>

      <div class="header-center">
        <div class="header-title">Qatar North ITS Survey Dashboard</div>
        <div class="header-subtitle">
          Traffic Junctions Dashboard · ITS Devices &amp; Systems
        </div>
        <div class="header-meta">
          Live from Google Sheet — assets, survey completion &amp; location
          overview · <span id="last-updated">Loading…</span>
        </div>
      </div>

      <div class="header-right">
        <img
          src="algosystems-logo.png"
          alt="Algosystems"
          class="header-logo"
        />
      </div>
    </header>

    <main>
      <!-- KPI GRID -->
      <section class="kpi-grid">
        <!-- row 1 -->
        <div class="card kpi-card">
          <div class="kpi-label">Total ITS Assets</div>
          <div class="kpi-value" id="total-assets-count">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">Assets Surveyed</div>
          <div class="kpi-value" id="assets-surveyed-count">–</div>
          <div class="kpi-subtext" id="assets-surveyed-percent-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">Survey Completion</div>
          <div class="kpi-value" id="survey-completion-percent">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="survey-completion-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="survey-completion-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">Assets Pending</div>
          <div class="kpi-value" id="assets-pending-count">–</div>
          <div class="kpi-subtext">Assets with survey status “Pending”.</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">CCTV Assets</div>
          <div class="kpi-value" id="cctv-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="cctv-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="cctv-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">DMS Assets</div>
          <div class="kpi-value" id="dms-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="dms-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="dms-survey-text">–</div>
        </div>

        <!-- row 2 -->
        <div class="card kpi-card">
          <div class="kpi-label">RVD Assets</div>
          <div class="kpi-value" id="rvd-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="rvd-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="rvd-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">PTZ Assets</div>
          <div class="kpi-value" id="ptz-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="ptz-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="ptz-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">LPR Assets</div>
          <div class="kpi-value" id="lpr-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="lpr-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="lpr-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">AID Assets</div>
          <div class="kpi-value" id="aid-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="aid-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="aid-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">OVDS Assets</div>
          <div class="kpi-value" id="ovds-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="ovds-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="ovds-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">RWIS Assets</div>
          <div class="kpi-value" id="rwis-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="rwis-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="rwis-survey-text">–</div>
        </div>

        <!-- row 3 -->
        <div class="card kpi-card">
          <div class="kpi-label">LCS Assets</div>
          <div class="kpi-value" id="lcs-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="lcs-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="lcs-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">AQMS Assets</div>
          <div class="kpi-value" id="aqms-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="aqms-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="aqms-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">Magnetometer AP</div>
          <div class="kpi-value" id="magap-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="magap-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="magap-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">Magnetometer Dots</div>
          <div class="kpi-value" id="magdot-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="magdot-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="magdot-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">WIM Sensor</div>
          <div class="kpi-value" id="wim-sensor-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="wim-sensor-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="wim-sensor-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">WIM Controller</div>
          <div class="kpi-value" id="wim-controller-assets-count">–</div>
          <div class="progress-track">
            <div
              class="progress-bar"
              id="wim-controller-survey-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="kpi-pct" id="wim-controller-survey-text">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">Assets in Doha Region</div>
          <div class="kpi-value" id="assets-doha-count">–</div>
        </div>

        <div class="card kpi-card">
          <div class="kpi-label">Assets in North Region</div>
          <div class="kpi-value" id="assets-north-count">–</div>
        </div>
      </section>

      <!-- FILTERS -->
      <section class="filters-row">
        <div class="card filters-card">
          <div class="filters-title">Filters</div>
          <div class="filters-grid">
            <div>
              <div class="field-label">Zone Area</div>
              <select id="zoneAreaFilter">
                <option value="All">All</option>
              </select>
            </div>
            <div>
              <div class="field-label">Device Type</div>
              <select id="deviceTypeFilter">
                <option value="All">All</option>
              </select>
            </div>
            <div>
              <div class="field-label">Survey Status</div>
              <select id="surveyStatusFilter">
                <option value="All">All</option>
                <option value="Completed">Completed</option>
                <option value="Pending">Pending</option>
              </select>
            </div>
          </div>

          <button id="downloadBtn" class="btn-primary">
            Download Current View (CSV)
          </button>
          <div class="filters-note">No filters applied.</div>
        </div>
      </section>

      <!-- MAP + TABLE -->
      <section class="layout-row">
        <div class="card map-card">
          <div class="map-title">ITS Assets Map (Leaflet / OpenStreetMap)</div>
          <div id="map"></div>
          <div class="map-footer" id="map-footer">
            Map shows surveyed (green) and pending (red) ITS assets in Qatar
            North.
          </div>
        </div>

        <div class="card table-card">
          <div class="table-title">ITS Asset List</div>

          <div class="table-header-grid">
            <div>
              <div class="field-label">
                Search by ID, Name, Device Type, Zone Area, or Remarks
              </div>
              <input
                type="text"
                id="assetSearch"
                class="search-input"
                placeholder="Start typing to filter the ITS asset list..."
              />
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th style="width: 70px">ID</th>
                  <th>Name</th>
                  <th>Device Type</th>
                  <th>Zone Area</th>
                  <th>Zone</th>
                  <th>Survey</th>
                  <th>Remarks</th>
                </tr>
              </thead>
              <tbody id="asset-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CHARTS -->
      <section class="bottom-row">
        <div class="card chart-card">
          <div class="chart-title">Assets by Device Type</div>
          <canvas id="deviceTypeChart"></canvas>
          <div class="chart-legend" id="chart-legend">
            Distribution of ITS assets by device type for the current
            selection.
          </div>
        </div>

        <div class="card chart-card">
          <div class="chart-title">
            Survey Completion % by Device Type
          </div>
          <canvas id="deviceCompletionChart"></canvas>
          <div class="chart-legend" id="completion-legend">
            Percentage of surveyed devices for each device type.
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // === CONFIG ==========================================================
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5yrlBZ6pktog25ogVRyoi6XkGGt9nUMjGaiCjGRmCEG82EZKTa8XHecxBpAmuPBcaZQ-0BiIlb4_w/pub?gid=1191966534&single=true&output=csv";

    // === GLOBAL STATE ====================================================
    let allAssets = [];
    let filteredAssets = [];

    let map;
    let markerLayer;
    let deviceTypeChart;
    let deviceCompletionChart;

    // === UTILITIES =======================================================

    function normalizeDeviceType(raw) {
      const s = (raw || "").toString().trim().toLowerCase();
      if (!s) return "";

      if (s === "dms" || s.includes("dms")) return "DMS";
      if (s === "rvd") return "RVD";
      if (s.includes("ptz")) return "PTZ";
      if (s.includes("lpr")) return "LPR";
      if (s.includes("aid")) return "AID";
      if (s.includes("ovds") || s.includes("overheight") || s.includes("over height"))
        return "OVDS";
      if (s.includes("rwis") || s.includes("weather")) return "RWIS";
      if (s.includes("wim") && s.includes("sensor")) return "WIM Sensor";
      if (s.includes("wim") && s.includes("controller")) return "WIM Controller";
      if (s.includes("mag") && s.includes("ap")) return "Magnetometer AP";
      if (s.includes("mag") && (s.includes("dot") || s.includes("detector")))
        return "Magnetometer Dots";
      if (s.includes("lcs") || s.includes("lane control"))
        return "LCS";
      if (s.includes("aqm") || s.includes("aqms") || s.includes("air quality"))
        return "AQMS";

      if (s.includes("cctv")) return "CCTV";

      return raw || "";
    }

    function normalizeZoneArea(rawZoneArea) {
      const txt = (rawZoneArea || "").toString().trim();
      const lower = txt.toLowerCase();
      if (lower.includes("doha")) return "Doha Region";
      if (lower.includes("north")) return "North Region";
      return txt || "";
    }

    function formatPercent(value) {
      if (!isFinite(value)) return "0.0%";
      return value.toFixed(1) + "%";
    }

    function setLastUpdated() {
      const span = document.getElementById("last-updated");
      const now = new Date();
      span.textContent = now.toLocaleString("en-GB", {
        weekday: "short",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });
    }

    // === DATA LOADING ====================================================

    function loadData() {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const rows = results.data || [];

          allAssets = rows
            .map((row) => {
              const lat = parseFloat(row["Latitude"]);
              const lng = parseFloat(row["Longitude"]);
              if (!isFinite(lat) || !isFinite(lng)) return null;

              const rawArea =
                row["Zone Area"] || row["Area"] || row["Zone"] || "";
              const zoneArea = normalizeZoneArea(rawArea);

              const surveyStatusRaw =
                (row["Survey Status"] || row["SurveyStatus"] || "").toString().trim().toUpperCase();
              const surveyStatus =
                surveyStatusRaw === "TRUE" || surveyStatusRaw === "COMPLETED"
                  ? "Completed"
                  : "Pending";

              const deviceType = normalizeDeviceType(row["Device Type"]);

              return {
                id: row["ID"],
                name: row["Name"],
                latitude: lat,
                longitude: lng,
                zoneArea,
                zone: row["Zone"] || "",
                deviceType,
                surveyStatus,
                remarks: row["Remarks from Survey Team"] || row["Remarks"] || ""
              };
            })
            .filter(Boolean);

          initFilters();
          applyFilters();
          setLastUpdated();
        }
      });
    }

    // === FILTERS & SEARCH ===============================================

    function initFilters() {
      const zoneAreaSelect = document.getElementById("zoneAreaFilter");
      const deviceTypeSelect = document.getElementById("deviceTypeFilter");

      const zoneAreas = Array.from(
        new Set(allAssets.map((a) => a.zoneArea).filter((x) => x))
      ).sort();

      zoneAreas.forEach((za) => {
        const opt = document.createElement("option");
        opt.value = za;
        opt.textContent = za;
        zoneAreaSelect.appendChild(opt);
      });

      const deviceTypes = Array.from(
        new Set(allAssets.map((a) => a.deviceType).filter((x) => x))
      ).sort();

      deviceTypes.forEach((dt) => {
        const opt = document.createElement("option");
        opt.value = dt;
        opt.textContent = dt;
        deviceTypeSelect.appendChild(opt);
      });

      zoneAreaSelect.addEventListener("change", applyFilters);
      deviceTypeSelect.addEventListener("change", applyFilters);
      document
        .getElementById("surveyStatusFilter")
        .addEventListener("change", applyFilters);
      document
        .getElementById("assetSearch")
        .addEventListener("input", applyFilters);
      document
        .getElementById("downloadBtn")
        .addEventListener("click", downloadCurrentView);
    }

    function applyFilters() {
      const zoneAreaValue = document.getElementById("zoneAreaFilter").value;
      const deviceTypeValue = document.getElementById("deviceTypeFilter").value;
      const surveyStatusValue =
        document.getElementById("surveyStatusFilter").value;
      const searchText = document
        .getElementById("assetSearch")
        .value.toLowerCase()
        .trim();

      filteredAssets = allAssets.filter((asset) => {
        if (zoneAreaValue !== "All" && asset.zoneArea !== zoneAreaValue)
          return false;
        if (deviceTypeValue !== "All" && asset.deviceType !== deviceTypeValue)
          return false;
        if (
          surveyStatusValue !== "All" &&
          asset.surveyStatus !== surveyStatusValue
        )
          return false;

        if (!searchText) return true;

        const haystack = (
          asset.id +
          " " +
          asset.name +
          " " +
          asset.deviceType +
          " " +
          asset.zoneArea +
          " " +
          asset.zone +
          " " +
          asset.remarks
        )
          .toLowerCase()
          .trim();

        return haystack.includes(searchText);
      });

      updateSummaryCards(filteredAssets);
      updateMap(filteredAssets);
      updateTable(filteredAssets);
      updateDeviceCharts(filteredAssets);
      updateFiltersNote();
    }

    function updateFiltersNote() {
      const zoneAreaValue = document.getElementById("zoneAreaFilter").value;
      const deviceTypeValue = document.getElementById("deviceTypeFilter").value;
      const surveyStatusValue =
        document.getElementById("surveyStatusFilter").value;
      const searchText = document
        .getElementById("assetSearch")
        .value.toLowerCase()
        .trim();

      const active = [];

      if (zoneAreaValue !== "All") active.push("Zone Area: " + zoneAreaValue);
      if (deviceTypeValue !== "All")
        active.push("Device Type: " + deviceTypeValue);
      if (surveyStatusValue !== "All")
        active.push("Survey: " + surveyStatusValue);
      if (searchText) active.push("Search text");

      const noteEl = document.querySelector(".filters-note");
      if (!active.length) {
        noteEl.textContent = "No filters applied.";
      } else {
        noteEl.textContent = "Active filters — " + active.join(" · ");
      }
    }

    // === SUMMARY CARDS ===================================================

    function deviceStats(assets, canonicalType) {
      const matching = assets.filter((a) => a.deviceType === canonicalType);
      const total = matching.length;
      const completed = matching.filter(
        (a) => a.surveyStatus === "Completed"
      ).length;
      const percent = total ? (completed / total) * 100 : 0;
      return { total, completed, percent };
    }

    function setCardStats(type, stats) {
      const { total, percent } = stats;
      const countEl = document.getElementById(`${type}-assets-count`);
      const barEl = document.getElementById(`${type}-survey-bar`);
      const textEl = document.getElementById(`${type}-survey-text`);
      if (!countEl || !barEl || !textEl) return;

      countEl.textContent = total.toString();
      barEl.style.width = percent.toFixed(1) + "%";
      textEl.textContent =
        stats.completed +
        " surveyed (" +
        formatPercent(isFinite(percent) ? percent : 0) +
        ")";
    }

    function updateSummaryCards(assets) {
      const total = assets.length;
      const surveyed = assets.filter(
        (a) => a.surveyStatus === "Completed"
      ).length;
      const pending = total - surveyed;
      const completionPct = total ? (surveyed / total) * 100 : 0;

      document.getElementById("total-assets-count").textContent = total;
      document.getElementById("assets-surveyed-count").textContent = surveyed;
      document.getElementById(
        "assets-surveyed-percent-text"
      ).textContent = formatPercent(completionPct) + " of ITS assets";
      document.getElementById("assets-pending-count").textContent = pending;

      document.getElementById("survey-completion-percent").textContent =
        formatPercent(completionPct);
      document.getElementById("survey-completion-bar").style.width =
        completionPct.toFixed(1) + "%";
      document.getElementById("survey-completion-text").textContent =
        surveyed +
        " of " +
        total +
        " assets surveyed (" +
        formatPercent(completionPct) +
        ").";

      const assetsDoha = assets.filter((a) =>
        a.zoneArea.toLowerCase().includes("doha")
      ).length;
      const assetsNorth = assets.filter((a) =>
        a.zoneArea.toLowerCase().includes("north")
      ).length;

      document.getElementById("assets-doha-count").textContent = assetsDoha;
      document.getElementById("assets-north-count").textContent = assetsNorth;

      setCardStats("cctv", deviceStats(assets, "CCTV"));
      setCardStats("dms", deviceStats(assets, "DMS"));
      setCardStats("rvd", deviceStats(assets, "RVD"));
      setCardStats("ptz", deviceStats(assets, "PTZ"));
      setCardStats("lpr", deviceStats(assets, "LPR"));
      setCardStats("aid", deviceStats(assets, "AID"));
      setCardStats("ovds", deviceStats(assets, "OVDS"));
      setCardStats("rwis", deviceStats(assets, "RWIS"));
      setCardStats("lcs", deviceStats(assets, "LCS"));
      setCardStats("aqms", deviceStats(assets, "AQMS"));
      setCardStats("magap", deviceStats(assets, "Magnetometer AP"));
      setCardStats("magdot", deviceStats(assets, "Magnetometer Dots"));
      setCardStats("wim-sensor", deviceStats(assets, "WIM Sensor"));
      setCardStats("wim-controller", deviceStats(assets, "WIM Controller"));
    }

    // === MAP =============================================================

    function initMap() {
      map = L.map("map", {
        center: [25.35, 51.45],
        zoom: 9
      });

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; <a href="https://openstreetmap.org">OSM</a> contributors'
      }).addTo(map);

      markerLayer = L.layerGroup().addTo(map);
    }

    function updateMap(assets) {
      if (!map) initMap();
      markerLayer.clearLayers();

      if (!assets.length) return;

      const bounds = [];

      assets.forEach((asset) => {
        const color =
          asset.surveyStatus === "Completed"
            ? "#16a34a"
            : "#dc2626";

        const marker = L.circleMarker([asset.latitude, asset.longitude], {
          radius: 6,
          color,
          fillColor: color,
          fillOpacity: 0.85,
          weight: 1
        });

        marker.bindPopup(
          `<strong>${asset.id || ""} - ${
            asset.name || ""
          }</strong><br/>
           <strong>Device:</strong> ${asset.deviceType || ""}<br/>
           <strong>Zone Area:</strong> ${asset.zoneArea || ""}<br/>
           <strong>Zone:</strong> ${asset.zone || ""}<br/>
           <strong>Survey:</strong> ${asset.surveyStatus}<br/>
           <strong>Remarks:</strong> ${asset.remarks || "—"}`
        );

        marker.addTo(markerLayer);
        bounds.push([asset.latitude, asset.longitude]);
      });

      if (bounds.length > 1) {
        map.fitBounds(bounds, { padding: [20, 20] });
      } else if (bounds.length === 1) {
        map.setView(bounds[0], 13);
      }
    }

    // === TABLE ===========================================================

    function updateTable(assets) {
      const tbody = document.getElementById("asset-table-body");
      tbody.innerHTML = "";

      assets.forEach((asset) => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = asset.id || "";
        tr.appendChild(tdId);

        const tdName = document.createElement("td");
        tdName.textContent = asset.name || "";
        tr.appendChild(tdName);

        const tdDevice = document.createElement("td");
        tdDevice.textContent = asset.deviceType || "";
        tr.appendChild(tdDevice);

        const tdArea = document.createElement("td");
        tdArea.textContent = asset.zoneArea || "";
        tr.appendChild(tdArea);

        const tdZone = document.createElement("td");
        tdZone.textContent = asset.zone || "";
        tr.appendChild(tdZone);

        const tdSurvey = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("badge");
        if (asset.surveyStatus === "Completed") {
          badge.classList.add("badge-success");
          badge.textContent = "Completed";
        } else {
          badge.classList.add("badge-pending");
          badge.textContent = "Pending";
        }
        tdSurvey.appendChild(badge);
        tr.appendChild(tdSurvey);

        const tdRemarks = document.createElement("td");
        tdRemarks.textContent = asset.remarks || "";
        tr.appendChild(tdRemarks);

        tbody.appendChild(tr);
      });
    }

    // === CHARTS ==========================================================

    function updateDeviceCharts(assets) {
      const ctxDonut = document
        .getElementById("deviceTypeChart")
        .getContext("2d");
      const ctxBar = document
        .getElementById("deviceCompletionChart")
        .getContext("2d");

      const counts = {};
      const completed = {};

      assets.forEach((a) => {
        const type = a.deviceType || "Unknown";
        counts[type] = (counts[type] || 0) + 1;
        if (a.surveyStatus === "Completed") {
          completed[type] = (completed[type] || 0) + 1;
        }
      });

      const labels = Object.keys(counts);
      const dataCounts = labels.map((l) => counts[l]);
      const dataPct = labels.map((l) =>
        counts[l] ? (completed[l] || 0) / counts[l] * 100 : 0
      );

      if (deviceTypeChart) {
        deviceTypeChart.destroy();
      }
      if (deviceCompletionChart) {
        deviceCompletionChart.destroy();
      }

      deviceTypeChart = new Chart(ctxDonut, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data: dataCounts,
              backgroundColor: [
                "#4f46e5",
                "#0ea5e9",
                "#10b981",
                "#6366f1",
                "#f97316",
                "#ec4899",
                "#a855f7",
                "#22c55e",
                "#eab308",
                "#f97316",
                "#06b6d4",
                "#94a3b8"
              ],
              borderWidth: 0
            }
          ]
        },
        options: {
          plugins: {
            legend: {
              position: "right",
              labels: {
                boxWidth: 10,
                boxHeight: 10,
                font: { size: 10 }
              }
            }
          },
          maintainAspectRatio: false
        }
      });

      deviceCompletionChart = new Chart(ctxBar, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Survey Completion %",
              data: dataPct,
              backgroundColor: "#22c55e"
            }
          ]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: (value) => value + "%"
              },
              title: {
                display: true,
                text: "Completion %"
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (ctx) =>
                  ctx.parsed.y.toFixed(1) + "% surveyed"
              }
            }
          },
          maintainAspectRatio: false
        }
      });

      document.getElementById("chart-legend").textContent =
        "Showing " +
        assets.length +
        " ITS assets across " +
        labels.length +
        " device type(s) for the current filter selection.";

      document.getElementById("completion-legend").textContent =
        "Bars show the percentage of surveyed devices for each device type.";
    }

    // === DOWNLOAD CURRENT VIEW ==========================================

    function downloadCurrentView() {
      if (!filteredAssets.length) {
        alert("No assets in the current view to export.");
        return;
      }

      const csvHeader = [
        "ID",
        "Name",
        "Device Type",
        "Zone Area",
        "Zone",
        "Latitude",
        "Longitude",
        "Survey Status",
        "Remarks"
      ];

      const rows = filteredAssets.map((a) => [
        a.id || "",
        a.name || "",
        a.deviceType || "",
        a.zoneArea || "",
        a.zone || "",
        a.latitude,
        a.longitude,
        a.surveyStatus,
        (a.remarks || "").replace(/\r?\n/g, " ")
      ]);

      const allRows = [csvHeader, ...rows];
      const csvContent = allRows
        .map((r) =>
          r
            .map((field) => {
              const f = field == null ? "" : field.toString();
              if (/[",\n]/.test(f)) {
                return '"' + f.replace(/"/g, '""') + '"';
              }
              return f;
            })
            .join(",")
        )
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "its-dashboard-current-view.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // === INIT ============================================================

    window.addEventListener("DOMContentLoaded", () => {
      initMap();
      loadData();
    });
  </script>
</body>
</html>