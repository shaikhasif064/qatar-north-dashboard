<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qatar North Traffic Junctions Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Chart.js for zone chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --aktor-blue: #1d2537;
      --aktor-red: #e0283b;
      --algo-blue: #0070c9;
      --bg: #f5f5f5;
      --card-bg: #ffffff;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: #222;
    }

    header {
      background: var(--card-bg);
      border-bottom: 1px solid #ddd;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .header-left,
    .header-right {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
    }

    .header-center {
      flex: 1 1 auto;
      text-align: center;
    }

    .logo-img {
      max-height: 54px;
      height: auto;
    }

    .logo-img-small {
      max-height: 40px;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--aktor-blue);
    }

    header .subtitle {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .updated-text {
      font-size: 11px;
      color: #666;
      white-space: nowrap;
    }

    .container {
      padding: 12px 24px 24px;
      display: grid;
      grid-template-columns: 1.5fr 1.2fr;
      grid-gap: 16px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      grid-gap: 12px;
      margin-bottom: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .card-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #888;
      margin-bottom: 6px;
    }

    .card-value {
      font-size: 24px;
      font-weight: 700;
      color: #333;
    }

    .card-sub {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 12px;
      overflow: hidden;
    }

    .right-col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .filters label {
      font-size: 11px;
      color: #444;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .filters select {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 11px;
      min-width: 110px;
    }

    .filters-row-title {
      font-size: 11px;
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    th,
    td {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background: #fafafa;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .table-wrapper {
      max-height: 310px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background: #fff;
    }

    .status-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      color: #fff;
    }

    .status-completed {
      background: #2e7d32;
    }

    .status-pending {
      background: #c62828;
    }

    .status-partial {
      background: #f9a825;
      color: #333;
    }

    .zone-chart-wrapper {
      height: 250px;
    }

    .zone-chart-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
      #map {
        height: 360px;
      }
      .header-center {
        text-align: left;
      }
      header {
        flex-wrap: wrap;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <!-- Left logo: AKTOR -->
      <img src="aktor-logo.png" alt="AKTOR Qatar" class="logo-img" />
    </div>

    <div class="header-center">
      <h1>Qatar North Traffic Junctions Dashboard</h1>
      <div class="subtitle">
        Live from Google Sheet · Junctions, Survey Completion &amp; Operations Status
      </div>
    </div>

    <div class="header-right">
      <!-- Right logo: ALGOSYSTEMS -->
      <img src="algosystems-logo.png" alt="ALGOSYSTEMS Qatar" class="logo-img logo-img-small" />
    </div>
  </header>

  <div class="container">
    <!-- LEFT COLUMN: KPIs + MAP + ZONE CHART -->
    <div>
      <div class="kpi-grid">
        <div class="card">
          <div class="card-title">Total Junctions</div>
          <div class="card-value" id="kpi-total">–</div>
        </div>
        <div class="card">
          <div class="card-title">Junctions Under O&amp;M</div>
          <div class="card-value" id="kpi-om">–</div>
        </div>
        <div class="card">
          <div class="card-title">Junctions Under Projects</div>
          <div class="card-value" id="kpi-projects">–</div>
        </div>
        <div class="card">
          <div class="card-title">Junctions Switched Off</div>
          <div class="card-value" id="kpi-off">–</div>
        </div>
        <div class="card">
          <div class="card-title">Survey Completed</div>
          <div class="card-value" id="kpi-survey-completed">–</div>
          <div class="card-sub" id="kpi-survey-pct">–</div>
        </div>
        <div class="card">
          <div class="card-title">Pole Survey Completed</div>
          <div class="card-value" id="kpi-pole-completed">–</div>
        </div>
        <div class="card">
          <div class="card-title">Controller Survey Completed</div>
          <div class="card-value" id="kpi-ctrl-completed">–</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Junction Map (Leaflet / OpenStreetMap)</div>
        <div id="map"></div>
        <div class="card-sub" id="lastUpdated" style="margin-top:6px;"></div>
      </div>

      <div class="card">
        <div class="card-title">Zone-wise Survey Completion</div>
        <div class="zone-chart-wrapper">
          <canvas id="zoneChart"></canvas>
        </div>
        <div class="card-sub">
          Percentage of junctions with completed survey status in each zone.
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: FILTERS + TABLE -->
    <div class="right-col">
      <div class="card">
        <div class="filters-row-title">Filters</div>
        <div class="filters">
          <label>
            Zone
            <select id="filter-zone">
              <option value="">All</option>
            </select>
          </label>
          <label>
            Survey Status
            <select id="filter-survey">
              <option value="">All</option>
              <option value="completed">Completed</option>
              <option value="pending">Pending</option>
            </select>
          </label>
          <label>
            Remarks
            <select id="filter-remarks">
              <option value="">All</option>
              <option value="om">Under O&amp;M</option>
              <option value="projects">Under Projects</option>
              <option value="off">Switched Off</option>
              <option value="other">Other</option>
            </select>
          </label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Junction List</div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Junct No</th>
                <th>Street</th>
                <th>Zone</th>
                <th>District</th>
                <th>Remarks</th>
                <th>Survey</th>
              </tr>
            </thead>
            <tbody id="junction-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Google Sheet CSV
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5pFct4J8nDgw7VLuUJpfVgxewoZSkjh-cNxjgtOOZcjEM5Hx0xyJsziL9MUrEmK6wuls0C2Ffd1ku/pub?gid=1921347271&single=true&output=csv";

    // Column names in your sheet
    const COLS = {
      junctNo: "Junct No",
      street: "Street Details",
      lat: "Latitude",
      lon: "Longitude",
      zone: "Zone No",
      district: "District",
      remarks: "Remarks",
      surveyStatus: "Survey Status",
      poleSurvey: "Pole Survey",
      ctrlSurvey: "Controller Survey",
    };

    function isTruthy(val) {
      if (val == null) return false;
      const v = String(val).trim().toLowerCase();
      return ["true", "yes", "1", "y", "done", "completed", "✓", "✔"].includes(
        v
      );
    }

    function classifySurvey(v) {
      return isTruthy(v) ? "completed" : "pending";
    }

    function classifyRemarks(remarks) {
      const r = (remarks || "").toLowerCase();
      if (r.includes("under o&m") || r.includes("under o & m")) return "om";
      if (r.includes("under projects") || r.includes("under project"))
        return "projects";
      if (r.includes("switched off") || r.includes("switch off")) return "off";
      return "other";
    }

    let allData = [];
    let map;
    let markersLayer;
    let zoneChart = null;

    function initMap() {
      map = L.map("map").setView([25.3, 51.4], 9); // Qatar

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    function clearMarkers() {
      markersLayer.clearLayers();
    }

    function addMarkers(data) {
      clearMarkers();
      data.forEach((row) => {
        const lat = parseFloat(row[COLS.lat]);
        const lon = parseFloat(row[COLS.lon]);
        if (isNaN(lat) || isNaN(lon)) return;

        const surveyClass = classifySurvey(row[COLS.surveyStatus]);
        let color = surveyClass === "completed" ? "#2e7d32" : "#c62828";

        const marker = L.circleMarker([lat, lon], {
          radius: 5,
          color,
          fillColor: color,
          fillOpacity: 0.9,
          weight: 1,
        });

        const popupHtml = `
          <strong>Junction ${row[COLS.junctNo] || ""}</strong><br/>
          ${row[COLS.street] || ""}<br/>
          Zone: ${row[COLS.zone] || ""} · District: ${
          row[COLS.district] || ""
        }<br/>
          Remarks: ${row[COLS.remarks] || ""}<br/>
          Survey: ${surveyClass === "completed" ? "Completed" : "Pending"}
        `;
        marker.bindPopup(popupHtml);
        marker.addTo(markersLayer);
      });

      if (data.length > 0) {
        const bounds = markersLayer.getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        }
      }
    }

    function updateKPIs(data) {
      const total = data.length;

      let om = 0,
        proj = 0,
        off = 0,
        surveyCompleted = 0,
        poleCompleted = 0,
        ctrlCompleted = 0;

      data.forEach((row) => {
        const remarksType = classifyRemarks(row[COLS.remarks]);
        if (remarksType === "om") om++;
        else if (remarksType === "projects") proj++;
        else if (remarksType === "off") off++;

        if (isTruthy(row[COLS.surveyStatus])) surveyCompleted++;
        if (isTruthy(row[COLS.poleSurvey])) poleCompleted++;
        if (isTruthy(row[COLS.ctrlSurvey])) ctrlCompleted++;
      });

      document.getElementById("kpi-total").textContent = total;
      document.getElementById("kpi-om").textContent = om;
      document.getElementById("kpi-projects").textContent = proj;
      document.getElementById("kpi-off").textContent = off;
      document.getElementById("kpi-survey-completed").textContent =
        surveyCompleted;
      const pct =
        total > 0 ? ((surveyCompleted / total) * 100).toFixed(1) + "%" : "–";
      document.getElementById("kpi-survey-pct").textContent =
        pct + " of total";
      document.getElementById("kpi-pole-completed").textContent =
        poleCompleted;
      document.getElementById("kpi-ctrl-completed").textContent =
        ctrlCompleted;
    }

    function updateZoneFilter(data) {
      const select = document.getElementById("filter-zone");
      const zones = Array.from(
        new Set(data.map((row) => row[COLS.zone]).filter((z) => z != null))
      ).sort((a, b) =>
        String(a).localeCompare(String(b), undefined, { numeric: true })
      );

      while (select.options.length > 1) {
        select.remove(1);
      }

      zones.forEach((z) => {
        const opt = document.createElement("option");
        opt.value = z;
        opt.textContent = z;
        select.appendChild(opt);
      });
    }

    function renderTable(data) {
      const tbody = document.getElementById("junction-table-body");
      tbody.innerHTML = "";

      data.forEach((row) => {
        const tr = document.createElement("tr");

        const surveyClass = classifySurvey(row[COLS.surveyStatus]);
        const statusText = surveyClass === "completed" ? "Completed" : "Pending";
        const statusClass =
          surveyClass === "completed" ? "status-completed" : "status-pending";

        tr.innerHTML = `
          <td>${row[COLS.junctNo] || ""}</td>
          <td>${row[COLS.street] || ""}</td>
          <td>${row[COLS.zone] || ""}</td>
          <td>${row[COLS.district] || ""}</td>
          <td>${row[COLS.remarks] || ""}</td>
          <td><span class="status-pill ${statusClass}">${statusText}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function buildZoneChart(data) {
      const zoneMap = new Map();

      data.forEach((row) => {
        const zone = row[COLS.zone] || "NA";
        if (!zoneMap.has(zone)) {
          zoneMap.set(zone, { total: 0, completed: 0 });
        }
        const entry = zoneMap.get(zone);
        entry.total++;
        if (isTruthy(row[COLS.surveyStatus])) entry.completed++;
      });

      const labels = Array.from(zoneMap.keys()).sort((a, b) =>
        String(a).localeCompare(String(b), undefined, { numeric: true })
      );
      const values = labels.map((z) => {
        const { total, completed } = zoneMap.get(z);
        return total > 0 ? +(completed / total * 100).toFixed(1) : 0;
      });

      const ctx = document.getElementById("zoneChart").getContext("2d");
      if (zoneChart) {
        zoneChart.destroy();
      }

      zoneChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Survey Completion %",
              data: values,
              backgroundColor: "rgba(0, 112, 201, 0.6)",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.parsed.y}% completed`,
              },
            },
          },
          scales: {
            x: {
              title: { display: true, text: "Zone No" },
            },
            y: {
              beginAtZero: true,
              max: 100,
              title: { display: true, text: "Completion %" },
              ticks: {
                callback: (v) => v + "%",
              },
            },
          },
        },
      });
    }

    function applyFilters() {
      const zoneVal = document.getElementById("filter-zone").value;
      const surveyVal = document.getElementById("filter-survey").value;
      const remarksVal = document.getElementById("filter-remarks").value;

      let filtered = allData.slice();

      if (zoneVal) {
        filtered = filtered.filter((row) => String(row[COLS.zone]) === zoneVal);
      }

      if (surveyVal) {
        filtered = filtered.filter(
          (row) => classifySurvey(row[COLS.surveyStatus]) === surveyVal
        );
      }

      if (remarksVal) {
        filtered = filtered.filter(
          (row) => classifyRemarks(row[COLS.remarks]) === remarksVal
        );
      }

      updateKPIs(filtered);
      addMarkers(filtered);
      renderTable(filtered);
      buildZoneChart(filtered);
    }

    function setLastUpdated() {
      const el = document.getElementById("lastUpdated");
      const now = new Date();
      el.textContent =
        "Last loaded: " +
        now.toLocaleString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
    }

    function loadData() {
      Papa.parse(SHEET_CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          allData = results.data;
          updateKPIs(allData);
          updateZoneFilter(allData);
          addMarkers(allData);
          renderTable(allData);
          buildZoneChart(allData);
          setLastUpdated();
        },
        error: function (err) {
          console.error("Error loading CSV:", err);
          alert("Error loading data. Check the CSV URL or internet connection.");
        },
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      initMap();
      loadData();

      document
        .getElementById("filter-zone")
        .addEventListener("change", applyFilters);
      document
        .getElementById("filter-survey")
        .addEventListener("change", applyFilters);
      document
        .getElementById("filter-remarks")
        .addEventListener("change", applyFilters);
    });
  </script>
</body>
</html>